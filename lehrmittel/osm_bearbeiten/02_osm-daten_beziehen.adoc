= OpenStreetMap-Daten beziehen und mit QGIS 3 nutzen
OpenSchoolMaps.ch -- Freie Lernmaterialien zu freien Geodaten und Karten
:xrefstyle: short
:imagesdir: ../../bilder/
include::../../snippets/lang/de.adoc[]
include::../../snippets/suppress_title_page.adoc[]

Eine Anleitung für Interessierte, für Lehrpersonen und beispielsweise Maturanden

== Übersicht

.Ziel
Das Ziel dieser Anleitung ist es aufzuzeigen, wie man OpenStreetMap-Daten beziehen und in QGIS 3 nutzen kann.

.Zielgruppe
Alle, die am Erstellen einer eigenen Karte (online, als druckbarer Plan) und die am Analysieren von Geodaten interessiert sind.

.Zeitplanung
Die Bearbeitung dieses Arbeitsblatts verlangt je nach Vorkenntnissen unterschiedlich viel Zeit, da man einzelne Abschnitte überspringen kann,
wenn man mit der jeweiligen Thematik schon vertraut ist.

[NOTE]
====
Bei dieser Anleitung geht es um das reine Nutzen bestehender Daten aus OpenStreetMap.
Wer selber Daten erfassen will, kann sich mit dem Arbeitsblatt
"Mit uMap eine thematische Online-Karte erstellen"
und auf https://learnosm.org/de/ informieren.
====

== OpenStreetMap-Daten extrahieren und downloaden

Die Daten von OpenStreetMap können in unterschiedlichen Datenformaten auf dem Rechner lokal gespeichert werden.
Daher werden wir zunächst einige dieser Dateiformaten genauer erläutern.

=== OpenStreetMap und Geoinformationssysteme

Die Geometrie der Objekte in OpenStreetMap (OSM) sind intern als topologische Strukturen (Node, Ways) abgelegt.
Und die Objekt-Attribute als Tags (Key-Value-Paare) nur teilweise strukturiert.
Dieses beliebig erweiterbare Datenschema muss für Geoinformationssysteme (GIS) und deren Formate zuerst umgewandelt werden.
Es gibt kein einheitliches "GIS"-Datenschema für OSM.
Kaum ein Export aus OSM ist darum gleich wie der andere.

=== Dateiformate

Grundsätzlich kann man OSM-eigene und analysierbare GIS-Formate unterscheiden.

* OSM-spezifische Formate sind v.a. OSM XML, und OSM PBF.
* GIS-kompatible Formate sind Geopackage (sowie verwandt: Spatialite/SQLite oder MBTile/SQLite), Shapefiles, GeoJSON (TopoJSON).
* Weitere GIS-Vektor-Formate sind: KML sowie GPX für den GPS-Datenaustausch.
* Weitere nicht weiter analysierbare Formate sind Bild-/Raster-Formate wie PNG, JPEG, SVG, PDF.

=== OpenStreetMap-Daten länderweise beziehen

Die Webseite https://geofabrik.de bietet OpenStreetMap-Daten für ganze Länder und Regionen an, die natürlich frei nutzbar sind.
Die Daten können als `.osm.pbf`, `.shp.zip` oder `.osm.bz2` heruntergeladen werden.
Die Daten sind in einzelne Regionen unterteilt.
Wenn man auf eine Region klickt, werden die Daten der Länder in dieser Region angezeigt.
Je nach Land kann man auch noch kleinere Ausschnitte aus dem Land herunterladen.
Wenn man den Mauszeiger über eine Region oder ein Land hält, sieht man in der Karte auf der rechten Seite der Webseite das jeweilige Gebiet.
Die Daten auf GeoFabrik werden alle 24 Stunden aktualisert mit den Daten von OpenStreetMap.
Das heisst, dass wenn man eigene Änderungen gerade in OpenstreetMap gemacht hat,
muss man mindestens 1 Tag warten bis sie auch auf Geofabrik verfügbar sind.
Stelle sicher welche Daten du herunterlädst, da einige mehrere Gigabyte gross sein können.

=== OSM.org

Auf https://openstreetmap.org können auch Daten heruntergeladen werden.
Diese können aber immer nur in kleinen, rechteckigen Abschnitten bezogen werden und nur im `OSM XML`-Format.

=== HOTOSM

Das Humanitarian OpenStreetMap Team (HOT) bietet auch einen Online-Service an, um Daten von OpenStreetMap herunterzuladen.
Um HOTOSM zu verwenden brauchst du lediglich einen OpenStreetMap Benutzerkonto und eine gültige E-Mail Adresse um die Daten herunterzuladen.
Nach dem Anmelden hat man auf der linken Seite die Exporteinstellungen und auf der rechten Seite die Karte, die man exportieren möchte.

.Export von HOTOSM
image::osm_editieren/osm-daten_beziehen/hotosm.png[]

Danach kannst du auf verschiedene Arten die Daten, die du herunterladen möchtest, auswählen.

Du kannst entweder:

* Eine Ortschaft in der Suche eingeben
* Mit Koordinaten eine Bounding Box angeben
* Eine Bounding Box selber zeichnen
* Ein Polygon zeichnen
* Die aktuelle Ansicht herunterladen
* Eine geojson Datei hochladen

Für die ersten zwei Möglichkeiten, muss nur das Suchfeld genutzt werden.
Entweder die gewünschte Ortschaft eingeben oder eine Bounding Box (Westen, Süden, Osten, Norden) angeben.

Um eine Bounding Box oder ein Polygon zu zeichnen muss auf der rechten Seite der Karte die _Draw_-Schaltfläche gedrückt werden.

Um die aktuelle Ansicht herunterzuladen muss auf die Schaltfläche _This View_ gedrückt werden.

Wenn du eine geojson Datei hochladen möchtest, kannst du dies mit der Schaltfläche _Import_ machen.
Eine Webseite die sich dafür eignet ist http://geojson.io.

CAUTION: Achte darauf, dass du keine Multipolygone hochlädst

Nachdem du deine geojson Datei erstellt hast mit z.b http://geojson.io musst du sie noch für HOTOSM anpassen.
Kopiere dir dazu das geojson in einen Texteditor.
Die einfachste Version verlangt nur eine Typangabe und eine Liste mit den Koordinaten:

.Format der JSON-Datei für HOTOSM
image::osm_editieren/osm-daten_beziehen/json_format.png[]

=== BBBike

BBBike bietet die Daten von Planet.osm in vielen verschiedenen Dateiformaten an.
Für die Extraktion muss lediglich eine Bounding Box erstellt werden.
Die Bounding Box kann maximal 24'000'000 km² gross sein, oder 512mb als Datei.
Nachdem du eine gültige E-Mail Adresse angegeben hast und der Extraktion einen Namen zugeteilt hast kannst du auf die _Extract_-Schaltfläche klicken.
Dir wird eine Benachrichtigung per E-Mail geschickt mit dem Download-Link.

=== OSMaxx

Mit OSMaxx können bestehende und neue Auszüge von OpenStreetMap in verschiedenen GIS-Formaten heruntergeladen werden.
Um OSMaxx nutzen zu können benötigt man ein OSM-Konto mit einer gültigen E-Mail Adresse.

Unter _Existing Excerpt / Country_ können bestehende Auszüge heruntergeladen werden.
Es kann ausgewählt werden in welchem Format die Datei heruntergeladen werden soll,
welches Koordinatensystem verwendet werden soll und wie viele Details angezeigt werden sollen.

Unter _New Excerpt_ kannst du eigene Bereiche von OpenStreetMap auswählen, die du herunterladen möchtest.
Dazu kann man ein Viereck oder ein Polygon über die Karte zeichnen.
Es kann widerum ausgewählt werden in welchem Format die Datei heruntergeladen werden soll,
welches Koordinatensystem verwendet werden soll und wie viele Details angezeigt werden sollen.

Das exportieren der Daten geht etwa 30 Minuten.

== OpenStreetMap-Daten in QGIS importieren oder direkt extrahieren

=== Mit Overpass-Turbo (empfohlen)

Die einfachste und schnellste Methode um OpenStreetMap-Daten in QGIS zu importieren ist mittels Overpass-Turbo.
Diese Methode eignet sich sowohl für Fortgeschrittene als auch für Anfänger.
Zuerst besuche die Overpass-Turbo Website unter: http://overpass-turbo.osm.ch/.

Wenn du die Website das erste Mal besuchst, sieht sie in etwa wie folgt aus:

.Startseite von Overpass-Turbo
image::osm_editieren/osm-daten_beziehen/startseite.PNG[]

Klicke auf den rot markierten Button "Wizard". Mit dem Wizard lassen sich ganz einfach Overpass-Abfragen erstellen.
Da wir als Beispiel nach Brotverkaufsstellen suchen, suchen wir nach Bäckereien und Supermärkten, da beide Brot verkaufen.
Als Ortschaft nehmen wir als Beispiel Uster. Die Abfrage sieht wie folgt aus:

.Overpass-Turbo Wizard-Abfrage
image::osm_editieren/osm-daten_beziehen/wizardAbfrage.PNG[]

Nachdem man auf "Abfrage erstellen und ausführen" klickt, erhält man folgendes:

.Resultat der Wizard-Abfrage
image::osm_editieren/osm-daten_beziehen/resultat.PNG[]

Das obige Resultat könnte man auch vereinfachen, indem man die "nodes", "ways" und "relations" zu "nwr" zusammenfasst.
Unten rechts sieht man rot markiert die verschiedenen Objekte. Wir haben 22 POIs und 5 Polygone. Da wir nur POIs möchten,
könnten wir mittels "out center" alle Flächen und Pfade in Punkte verwandeln.
Die neue Abfrage würde dann folgendermassen aussehen.

  [out:json][timeout:25];
  {{geocodeArea:Uster}}->.searchArea;
  (
    nwr["shop"="bakery"](area.searchArea);
    nwr["shop"="supermarket"](area.searchArea);
  );
  out center;

Wenn wir jetzt die oberen Zeilen kopieren und ins Overpass-Turbo als Abfrage einfügen und ausführen, erhält man folgendes:

.Überarbeitetes Resultat
image::osm_editieren/osm-daten_beziehen/resultatNeu.PNG[]

Jetzt sehen wir unten rechts, dass die angezeigten Objekte nur noch aus POIs bestehen.
Wir haben jetzt 27 POIs und 0 Polygone, da wir die 5 Polygone in POIs umgewandelt haben mittels "out center".

Um diese Daten, also die POIs, ins QGIS übertragen bedienen wir uns einem Tool namens QuickOSM.
Falls es auf deinem Rechner noch nicht installiert ist, gehst du unter "Erweiterungen" auf "Erweiterungen verwalten und installieren".
Danach gibst du QuickOSM ins Suchfeld ein und installierst es. Das unten abgebildete Bild zeigt die Installation.

.Installation von QuickOSM
image::osm_editieren/osm-daten_beziehen/quick_osm.png[]

Nachdem du QuickOSM installiert hast, kannst du die Abfrage von Overpass-Turbo kopieren (vergl. Abb. 5).

CAUTION: Wir nehmen die erste Abfrage, welche Overpass-Turbo für uns erzeugt hat. Dies deshalb, da QuickOSM "out center" noch nicht unterstützt.

Nun wählen wir unter "Vektor" in der Menüleiste "QuickOSM" aus. Sobald das QuickOSM-Fenster erschienen ist, wählen wir auf der linken Seite
"Abfrage" aus. Im grossen Textfeld fügen wir die zuvor aus Overpass-Turbo kopierte Abfrage ein und klicken auf "Ausführen". 
Danach sollte es bei dir so aussehen:

.QuickOSM Abfrage
image::osm_editieren/osm-daten_beziehen/abfrage.PNG[]

Jetzt haben wir die POIs und Polygone, welche entweder Bäckereien oder Supermärkte in Uster sind, in QGIS importiert.
Das sollte dann ungefähr so aussehen:

.QGIS ohne Hintergrundlayer
image::osm_editieren/osm-daten_beziehen/qgis_no_background.PNG[]

Um Uster als Hintergrund in QGIS zu haben, müssen wir ein weiteres Plug-In installieren.
Wie vorher das QuickOSM installieren wir jetzt "QuickMapServies".
Sobald es installiert wurd gehen wir unter "Web" auf "QuickMapServies" und wählen dort "OSM" und dann "OSM Standard" aus.$
Jetzt wurde ein Layer erstellt mit den OpenStreetMap-Daten zu Uster, das so aussieht:

.QGIS mit Hintergrundlayer
image::osm_editieren/osm-daten_beziehen/qgis_with_background.PNG[]

Jetzt geht es darum, die 5 Polygone in Punkte zu verwandeln und diese dann mit den restlichen Punkten zu summieren.
Um dies zu erreichen gehen wir unter "Vektor" auf "Geometrie-Werkzeuge" und dann auf "Zentroide...".
Als Eingabelayer wählen wir die Flächen aus.

.Zentroide
image::osm_editieren/osm-daten_beziehen/zentroide.PNG[]

Wenn wir dann auf "Im Hintergrund ausführen" klicken, ändert sich der Dialog wie folgt:

.Zentroide ausgeführt
image::osm_editieren/osm-daten_beziehen/zentroide_ausgefuehrt.PNG[]

Nun sehen wir auf der linken Seite einen neuen Layer namens "Zentroide".
Den alten Layer mit den Polygonen können wir nun löschen. Dann sieht unser QGIS wie folgt aus:

.QGIS mit Zentroide
image::osm_editieren/osm-daten_beziehen/qgis_mit_zentroide.PNG[]

Um die Punktelayer zusammenzuführen, müssen wir unter "Vektor" auf "Datenmanagement-Werkzeuge" und dann auf "Vektorlayer Zusammenführen".
Dann wählen wir als Eingabelayer unsere zwei Punktelayer aus und klicken wieder auf "Im Hintergrund ausführen".

Diese zwei Schritte sehen so aus:

.Vektorlayer 
image::osm_editieren/osm-daten_beziehen/vektorlayer.PNG[]

.Vektorlayer ausgeführt
image::osm_editieren/osm-daten_beziehen/vektorlayer_ausgefuehrt.PNG[]

Nun haben wir in der linken Layermaske einen neuen Layer namens "zusammengeführt" erhalten.
Die alten Punktelayer können wir löschen und dem neuen einen passenden Namen geben, beispielsweise "Brotverkaufsstellen".
Das Resultat sollte dann so aussehen:

.Resultat
image::osm_editieren/osm-daten_beziehen/fertiges_qgis.PNG[]

=== Direkt aus QGIS (mit Plugin)

Nun schauen wir uns eine andere Methode an, um in QGIS OpenStreetMap-Daten zu importieren und zu verwalten.
Zuerst lösche den vorher erzeugten Punktelayer und übrig bleibt nur der OSM-Layer. So sollte es aussehen:

.OpenStreetMap in QGIS
image::osm_editieren/osm-daten_beziehen/osm_in_qgis.PNG[]

Öffne nun wieder das Plugin QuickOSM unter "Vektor" in der Menüleiste. Dann gibt folgende Abfrage ein:

.Bakery-Abfrage
image::osm_editieren/osm-daten_beziehen/quickOSM_bakery.PNG[]
