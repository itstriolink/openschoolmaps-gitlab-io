= OpenStreetMap-Daten beziehen und mit QGIS 3 nutzen
OpenSchoolMaps.ch -- Freie Lernmaterialien zu freien Geodaten und Karten
:xrefstyle: short
:imagesdir: ../../bilder/
include::../../snippets/lang/de.adoc[]
include::../../snippets/suppress_title_page.adoc[]

Eine Anleitung für Interessierte, für Lehrpersonen und beispielsweise Maturanden

== Übersicht

.Ziel
Das Ziel dieser Anleitung ist es aufzuzeigen, wie man OpenStreetMap-Daten beziehen und in QGIS 3 nutzen kann.

.Zielgruppe
Alle, die am Erstellen einer eigenen Karte (online, als druckbarer Plan) und die am Analysieren von Geodaten interessiert sind.

.Zeitplanung
Die Bearbeitung dieses Arbeitsblatts verlangt je nach Vorkenntnissen unterschiedlich viel Zeit, da man einzelne Abschnitte überspringen kann,
wenn man mit der jeweiligen Thematik schon vertraut ist.

[NOTE]
====
Bei dieser Anleitung geht es um das reine Nutzen bestehender Daten aus OpenStreetMap.
Wer selber Daten erfassen will, kann sich mit den Arbeitsblättern
"OpenStreetMap bearbeiten" und "Mit uMap eine thematische Online-Karte erstellen" 
sowie auf https://learnosm.org/de/ informieren.
====

== OpenStreetMap-Daten extrahieren und downloaden

Die Daten von OpenStreetMap können in unterschiedlichen Datenformaten auf dem Rechner lokal gespeichert werden.
Daher werden wir zunächst einige dieser Dateiformate genauer erläutern.

=== OpenStreetMap und Geoinformationssysteme

Die Geometrie der Objekte in OpenStreetMap (OSM) sind intern als topologische Strukturen (Node, Ways) abgelegt.
Und die Objekt-Attribute als Tags (Key-Value-Paare) nur teilweise strukturiert.
Dieses beliebig erweiterbare Datenschema muss für Geoinformationssysteme (GIS) und deren Formate zuerst umgewandelt werden.
Es gibt kein einheitliches "GIS"-Datenschema für OSM.
Kaum ein Export aus OSM ist darum gleich wie der andere.

=== Dateiformate

Grundsätzlich kann man OSM-eigene und analysierbare GIS-Formate unterscheiden.

* OSM-spezifische Formate sind v.a. OSM XML, und OSM PBF.
* GIS-kompatible Formate sind Geopackage (sowie verwandt: Spatialite/SQLite oder MBTile/SQLite), Shapefiles, GeoJSON (TopoJSON).
* Weitere GIS-Vektor-Formate sind: KML sowie GPX für den GPS-Datenaustausch.
* Weitere nicht weiter analysierbare Formate sind Bild-/Raster-Formate wie PNG, JPEG, SVG, PDF.

=== Geofabrik

Die Webseite von Geofabrik http://download.geofabrik.de/ bietet OpenStreetMap-Daten 
für ganze Länder und Regionen an, die natürlich frei nutzbar sind.
Die Daten können dort als Shapefiles (`.shp.zip`) oder aber in den 
OSM-spezifischen Formaten `.osm.pbf` und `.osm.bz2` heruntergeladen werden.

Die Daten sind in einzelne Regionen unterteilt.
Wenn man auf eine Region klickt, werden die Daten der Länder in dieser Region angezeigt.
Je nach Land kann man auch noch kleinere Ausschnitte aus dem Land herunterladen.
Wenn man den Mauszeiger über eine Region oder ein Land hält, sieht man in der Karte auf der rechten Seite der Webseite das jeweilige Gebiet.
Die Daten auf GeoFabrik werden alle 24 Stunden aktualisert mit den Daten von OpenStreetMap.
Das heisst, dass wenn man eigene Änderungen gerade in OpenstreetMap gemacht hat,
muss man mindestens einen Tag warten bis sie auch auf Geofabrik verfügbar sind.
Stelle sicher welche Daten du herunterlädst, da einige mehrere Gigabyte gross sein können.

Das Shapefile ist ein GIS-Vektor-Format und damit nach bestimmten Layer ('Feature-Klassen') strukturiert. 
Um bestimmte Objekte zu finden, wie beispielsweise Bäckereien (in OSM Tag shop=bakery) 
oder Supermärkte (Tag shop=supermarket) musst du die Dokumentation des 
"Layered GIS Format" auf https://www.geofabrik.de/de/data/shapefiles.html[Geofabrik]
- oder aber die Daten selber - konsultieren.


=== OSM.org

Auf https://openstreetmap.org können auch Daten heruntergeladen werden.
Diese können aber nur als quadratische Ausschnitte und bis max. 50'000 Nodes 
bezogen werden und zudem nur im `OSM XML`-Format.

=== HOTOSM

Das Humanitarian OpenStreetMap Team (HOT) bietet auch einen Online-Service an, um Daten von OpenStreetMap herunterzuladen.
Um HOTOSM zu verwenden brauchst du lediglich einen OpenStreetMap Benutzerkonto und eine gültige E-Mail Adresse um die Daten herunterzuladen.
Nach dem Anmelden sieht man folgendes

* Exportbeschreibung
* Formate
* Data
* Summary 

Tabulator 1 und 3 sollen nachfolgend etwas genauer beschrieben werden.

Bei Tabulator 1  sieht man auf der linken Seite die Exporteinstellungen und auf der rechten Seite die Karte, die man exportieren möchte.

.Export von HOTOSM
image::osm_editieren/osm-daten_beziehen/hotosm.png[]

Danach kannst du auf verschiedene Arten die Daten, die du herunterladen möchtest, auswählen.

Du kannst entweder:

* Eine Ortschaft in der Suche eingeben
* Mit Koordinaten eine Bounding Box angeben
* Eine Bounding Box selber zeichnen
* Ein Polygon zeichnen
* Die aktuelle Ansicht herunterladen
* Eine GeoJSON Datei hochladen

Für die ersten zwei Möglichkeiten, muss nur das Suchfeld genutzt werden.
Entweder die gewünschte Ortschaft eingeben oder eine Bounding Box (Westen, Süden, Osten, Norden) angeben.

Um eine Bounding Box oder ein Polygon zu zeichnen muss auf der rechten Seite der Karte die _Draw_-Schaltfläche gedrückt werden.

Um die aktuelle Ansicht herunterzuladen muss auf die Schaltfläche _This View_ gedrückt werden.

Wenn du eine GeoJSON Datei hochladen möchtest, kannst du dies mit der Schaltfläche _Import_ machen.
Eine Webseite die sich dafür eignet ist http://geojson.io.

CAUTION: Achte darauf, dass du keine Multipolygone hochlädst

Nachdem du deine GeoJSON Datei erstellt hast mit z.b http://geojson.io musst du sie noch für HOTOSM anpassen.
Kopiere dir dazu das GeoJSON in einen Texteditor.
Die einfachste Version verlangt nur eine Typangabe und eine Liste mit den Koordinaten:

.Format der JSON-Datei für HOTOSM
image::osm_editieren/osm-daten_beziehen/json_format.png[]

Bei Tabulator 2 wählst du das Format, z.B. GeoPackage oder OSM.pbf. 

Bei Tabulator 3  wählst du die GIS-Layer wie beispielsweise "supermarket" oder 
weitere Layer wie beispielsweise alle "Buildings". Wenn du damit zufrieden bist, 
kannst du mit "Nächstes" zum Tabulaor 4 "Summary" vorrücken und den Export erstellen.

Wenn du nach Bakery suchst, wird es nicht gefunden. Es ist aber möglich, das zu konfigurieren.

Um noch zusätzlich Bakeries zu konfigurieren, bleiben wir auf Tabulator 3 und gehen noch nicht 
zu Tabulator 4. Wir befinden uns im Register "Tag Tree" und wechseln zu "YAML".

In der WHERE-Bedingung, also in den Zeilen nach "where:" sehen wir eine Zeile mit "shop=supermarket".
Neben dieser Zeile schreiben wir einfach "shop=bakery" dazu und verknüpfen dies mit dem OR-Operator.

Das müssen wir zweimal machen, einmal für planet_osm_point und einmal für planet_osm_polygon.
Das Ergebnis sieht dann so aus:

.Konfigurieren des YAML
image::osm_editieren/osm-daten_beziehen/hotExportTool_yaml.PNG[]

Sobald du das gemacht hast, kannst du wieder zu Tabulator 4 wechseln und den Export erstellen.

=== OSMaxx

Mit OSMaxx können bestehende und neue Auszüge von OpenStreetMap in verschiedenen GIS-Formaten heruntergeladen werden.
Um OSMaxx nutzen zu können benötigt man ein OSM-Konto mit einer gültigen E-Mail Adresse.

Unter _Existing Excerpt / Country_ können bestehende Auszüge heruntergeladen werden.
Es kann ausgewählt werden in welchem Format die Datei heruntergeladen werden soll,
welches Koordinatensystem verwendet werden soll und wie viele Details angezeigt werden sollen.

Unter _New Excerpt_ kannst du eigene Bereiche von OpenStreetMap auswählen, die du herunterladen möchtest.
Dazu kann man ein Viereck oder ein Polygon über die Karte zeichnen.
Es kann widerum ausgewählt werden in welchem Format die Datei heruntergeladen werden soll,
welches Koordinatensystem verwendet werden soll und wie viele Details angezeigt werden sollen.

Das Exportieren der Daten geht etwa 45 Minuten. 

Falls du ein GIS-Format gewählt hast und wissen möchtest, ob und wo es zum Beispiel
Bäckereien hat, gehe zur "About"-Seite von OSMaxx, wo das Datenschema dokumentiert ist.

=== BBBike

BBBike https://extract.bbbike.org/ bietet die Daten von Planet.osm in vielen verschiedenen Dateiformaten an.
Für die Extraktion muss lediglich eine Bounding Box erstellt werden.
Die Bounding Box kann maximal 24'000'000 km² gross sein, oder 512mb als Datei.
Nachdem du eine gültige E-Mail Adresse angegeben hast und der Extraktion einen Namen zugeteilt hast kannst du auf die _Extract_-Schaltfläche klicken.
Dir wird eine Benachrichtigung per E-Mail geschickt mit dem Download-Link.
Die Dokumentation des Schemas, das hinter den GIS-Formaten wie z.B. GeoPackage oder 
Shapefile steckt, findest du hier:

* http://www.geopackage.org/spec/
* https://www.esri.com/library/whitepapers/pdfs/shapefile.pdf

== OpenStreetMap-Daten in QGIS importieren oder direkt extrahieren

=== Mit Overpass-Turbo

Die einfachste und schnellste Methode um OpenStreetMap-Daten in QGIS zu importieren, ist mittels Overpass-Turbo.
Diese Methode eignet sich sowohl für Fortgeschrittene als auch für Anfänger.
Zuerst besuche die Overpass-Turbo Website unter: http://overpass-turbo.osm.ch/.

Wenn du die Website das erste Mal besuchst, sieht sie in etwa wie folgt aus:

.Startseite von Overpass-Turbo
image::osm_editieren/osm-daten_beziehen/startseite.PNG[]

Klicke auf den rot markierten Button "Wizard". Mit dem Wizard lassen sich ganz einfach Overpass-Abfragen erstellen.
Da wir als Beispiel nach Brotverkaufsstellen suchen, suchen wir nach Bäckereien und Supermärkten, da beide Brot verkaufen.
Als Ortschaft nehmen wir als Beispiel Uster. Die Abfrage sieht wie folgt aus:

.Overpass-Turbo Wizard-Abfrage
image::osm_editieren/osm-daten_beziehen/wizardAbfrage.PNG[]

Nachdem man auf "Abfrage erstellen und ausführen" klickt, erhält man folgendes:

.Resultat der Wizard-Abfrage
image::osm_editieren/osm-daten_beziehen/resultat.PNG[]

Das obige Resultat könnte man auch vereinfachen, indem man die "nodes", "ways" und 
"relations" zu "nwr" (=noses/ways/relations) ersetzt bzw. zusammenfasst.
Unten rechts sieht man rot markiert die verschiedenen Objekte. Wir haben 22 POIs und 5 Polygone. Da wir nur POIs möchten,
könnten wir mittels "out center" alle Flächen und Pfade in Punkte verwandeln.
Die neue Abfrage würde dann folgendermassen aussehen.

  [out:json][timeout:25];
  {{geocodeArea:Uster}}->.searchArea;
  (
    nwr["shop"="bakery"](area.searchArea);
    nwr["shop"="supermarket"](area.searchArea);
  );
  out center;

Wenn wir jetzt die oberen Zeilen kopieren und ins Overpass-Turbo als Abfrage einfügen und ausführen, erhält man folgendes:

.Überarbeitetes Resultat
image::osm_editieren/osm-daten_beziehen/resultatNeu.PNG[]

Jetzt sehen wir unten rechts, dass die angezeigten Objekte nur noch aus POIs bestehen.
Wir haben jetzt 27 POIs und 0 Polygone, da wir die 5 Polygone mittels "out center" in POIs umgewandelt haben und 
Overpass diese 5 neuen POIs zu den bestehenden 22 POIs addiert hat.

Nun müssen wir die Abfrage noch als GeoJSON abspeichern. Dazu gehen wir oben links neben "Wizard" auf "Export".
Das Fenster das erscheint gibt uns verschiedene Exportmöglichkeiten, wir wählen die oberste, also "Speichern als GeoJSON".

.Overpass Export
image::osm_editieren/osm-daten_beziehen/overpass_export.PNG[]

Das heruntergeladene GeoJSON File fügen wir nun mittels drag & drop in das linke Layermenü in QGIS ein.
Zusätzlich benennen wir den Layer passend um, beispielsweise "Brotverkaufsstellen".

Unser QGIS sieht nun so aus:

.GeoJSON in QGIS importiert
image::osm_editieren/osm-daten_beziehen/geoJSON_in_qgis.PNG[]

Als letztes wollen wir das Koordinatensystem des in QGIS importierten GeoJSON ändern und dann als GeoPackage speichern.
Um das zu erreichen, machen wir einen Rechtsklick auf den Layer, gehen auf "Exportieren" und dann wählen wir den 
obersten Eintrag "Save Feature As...". Wir ändern das KBS zu "EPSG:2056 - CH1903+/LV95" und geben der Datei einen Namen.
Das Format belassen wir als GeoPackage und klicken dann auf "Ok".

Unten siehst du noch das Exportfenster:

.Als .gpkg Exportieren
image::osm_editieren/osm-daten_beziehen/brotverkaufsstellen_gpkg.PNG[]

Sehr gut, du hast es geschafft OpenStreetMap-Daten in QGIS zu importieren und als neues Format abzuspeichern.
Sehen wir uns noch eine andere Möglichkeit an OpenStreetMap-Daten in QGIS zu importieren.

=== Direkt aus QGIS mit dem QuickOSM-Plugin

Nun schauen wir uns eine andere Methode an, um in QGIS OpenStreetMap-Daten zu importieren und zu verwalten.
Lösche am besten den vorher erzeugten Layer und fange von Null an, um Verwirrungen zu vermeiden.
Ich benutze an dieser Stelle einen OSM Standard Layer als Hintergrund, um die Daten anschaulicher zu präsentieren.
Da ich davon ausgehe, dass du diesen nicht hast, ist nicht weiter schlimm, den er ist nicht zwingend nötig, 
also kannst du ruhig ohne OSM Standard Layer als Hintergrund das folgende Unterkapitel lesen.

.QGIS
image::osm_editieren/osm-daten_beziehen/osm_in_qgis.PNG[]

Zuerst installieren wir das Plugin namens QuickOSM, womit sich direkt in QGIS Abfragen erstellen lassen.
Dafür gehen wir in der oberen Menüleiste auf "Erweiterungen" und dann auf "Erweiterungen verwalten und installieren...".
In das Suchfeld gibst du QuickOSM ein und da es nur ein Plugin unter diesem Namen gibt, sollte dir auch das richtige angezeigt werden.
Jetzt klickst du auf "Erweiterung installieren" und schon kannst du mit dem Plugin arbeiten.

Das folgende Bild zeigt die Installation des Plugin:

.QuickOSM Installation
image::osm_editieren/osm-daten_beziehen/quick_osm.png[]

Nun öffnen wir das Plugin indem wir in der Menüleiste auf "Vektor" und dann auf "Quick OSM" klicken. 
Danach geben wir folgende Abfrage ein, um nach Bäckereien in Uster zu suchen:

.Bakery-Abfrage
image::osm_editieren/osm-daten_beziehen/quickOSM_bakery.PNG[]

Nachdem die Abfrage ausgeführt wurde, machen wir noch eine zweite Abfrage um nach Supermärkten zu suchen:

.Supermarket-Abfrage
image::osm_editieren/osm-daten_beziehen/quickOSM_supermarket.PNG[]

Nun solltest du folgende Layer haben:

.Ergebnisse der QuickOSM-Abfragen
image::osm_editieren/osm-daten_beziehen/abfrage_ergebnisse.PNG[]

Jetzt haben wir zwei Punktelayer und zwei Polygonlayer. Da wir aber nur an Punktelayer insteressiert sind, 
müssen wir noch die Polygonlayer in Punktelayer umwandeln. Dafür gehst du unter "Vektor" zu "Geometrie-Werkzeuge" 
und dann zu "Zentroide...". Danach sollte dein QGIS so aussehen, wobei ich die Namen der neuen Layer bereits umbenannt habe:

.Polygonlayer umgewandelt
image::osm_editieren/osm-daten_beziehen/vier_punktelayer.PNG[]

Da wir jetzt vier Punktelayer haben, müssen wir diese nun zusammenführen. Dazu gehe unter "Vektor" zu "Datenmanagement-Werkzeuge" und 
dann zu "Vektorlayer zusammenführen". Im Dialogfenster wählst du die vier Layer aus:

.Layer zusammenführen
image::osm_editieren/osm-daten_beziehen/layer_merge.PNG[]

Nachdem du es ausgeführt hast, siehst du auf der linken Seite einen neuen Layer.
Die alten Layer brauchst du nun nicht mehr und du kannst sie somit löschen.
Dem neuen Layer gibst du einen passenden Namen, beispielsweise "Brotverkaufsstellen".
Unten siehst du das Endergebnis dieser zweiten Methode:

.Endergebnis
image::osm_editieren/osm-daten_beziehen/brotverkaufsstellen.PNG[]
