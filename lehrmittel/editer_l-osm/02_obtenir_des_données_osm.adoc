= Obtenir des données OpenStreetMap et les utiliser avec QGIS 3
OpenSchoolMaps.ch -- Freie Lernmaterialien zu freien Geodaten und Karten
:xrefstyle: short
:imagesdir: ../../bilder/
include::../../snippets/suppress_title_page.adoc[]

*Un guide pour les intéressés, pour les élèves et pour les instructeurs/enseignants*

== Aperçu

.Objectif
Le but de ce guide est de montrer comment obtenir des données 
OpenStreetMap et les utiliser dans QGIS 3.

.Public cible
Toute personne intéressée par la création de sa propre carte (carte web en ligne, 
carte imprimable) ou par l'analyse de géodonnées disponibles gratuitement dans le monde entier.
Si vous ne connaissez pas encore OpenStreetMap, vous devriez lire les feuilles de travail 
"Utilisation du site OSM.org au quotidien" et "Recherche des données OpenStreetMap".

.Planification
Cette feuille de travail exige un temps différent en fonction de 
vos connaissances antérieures, car vous pouvez sauter des sections 
individuelles si vous n'êtes intéressé que par certains sujets ou solutions.

.Structure
Les sujets suivants seront abordés:

* Introduction avec des explications sur OpenStreetMap et les systèmes 
d'information géographique ainsi que sur les formats de fichiers courants.
* Extraction des données OpenStreetMap avec Overpass 
* Importez des données OpenStreetMap directement dans QGIS avec le plugin QuickOSM
* Divers outils Web pour télécharger les données OpenStreetMap
* Fusion des calques de polygone avec les calques de points dans QGIS
* Filtrage ou affichage d'objets basé sur des règles avec QGIS

Nous vous recommandons de lire au moins l'introduction et le chapitre 
"Extraction des données OpenStreetMap avec Overpass".

[NOTE]
====
Ce tutoriel traite de l'utilisation des données existantes dans OpenStreetMap.
Si vous souhaitez enregistrer des données vous-même, vous pouvez utiliser les 
feuilles de travail "Edit OpenStreetMap" et "Create a thematic online map with 
uMap" ainsi que https://learnosm.org/de/ pour plus d'informations.
====

== Initiation

Les données d'OpenStreetMap sont disponibles dans différents formats de données.
C'est pourquoi nous allons d'abord expliquer plus en détail certains de ces formats de fichiers.

=== OpenStreetMap et les systèmes d'information géographique

La géométrie des objets dans OpenStreetMap (OSM) est stockée en interne sous forme 
de structures topologiques (nœuds, voies) et les attributs des objets sous forme 
de tags (paires clé-valeur) ne sont que partiellement structurés.
Ce schéma de données, qui peut être étendu à volonté, doit d'abord être converti 
pour les systèmes d'information géographique (SIG) et leurs formats.
Il n'existe pas de schéma de données SIG unique pour l'OSM.
Pratiquement aucune exportation de l'OSM n'est donc identique à l'autre.

=== Formats de fichiers

Fondamentalement, on peut faire la distinction entre les formats SIG propres à 
l'OSM et les formats SIG analysables.

* Les formats spécifiques à l'OSM sont principalement OSM XML et OSM PBF.
* Les formats compatibles SIG sont GeoJSON, GeoPackage, Shapefiles et GeoJSON.
* Les autres formats vectoriels SIG sont : KML et GPX pour l'échange de données GPS.
* D'autres formats qui ne peuvent pas être analysés plus avant sont les formats 
d'images/raster tels que PNG, JPEG et PDF.

[NOTE]
====
Ce qui suit décrit les différentes méthodes d'importation des 
données OpenStreetMap dans QGIS. 
La première méthode fonctionne avec Overpass-Turbo, un service web pour 
interroger les données OpenStreetMap. 
Nous vous recommandons d'examiner d'abord cette méthode, car c'est la plus 
efficace de toutes les méthodes présentées. 
La seconde méthode est basée sur QuickOSM, un plugin pour QGIS qui vous 
permet de créer des requêtes OpenStreetMap directement dans QGIS. 
C'est à vous de décider quelle méthode vous voulez utiliser. 

Après les deux méthodes d'importation, différents outils Web sont présentés 
pour télécharger les données OpenStreetMap. 

Dans les deux derniers chapitres, vous apprendrez comment éditer 
les géodonnées importées dans QGIS.
====

== Extraction des données OpenStreetMap avec Overpass

Avant d'en venir aux tâches, nous devons clarifier certaines ambiguïtés. 
Puisque nous travaillons avec des géodonnées, il serait logique de s'entendre sur un emplacement. 
Nous avons aussi besoin de savoir quel type de données nous voulons traiter pour cette ville. 
C'est pourquoi, dans toutes les sections suivantes, nous utiliserons Uster (canton ZH) 
comme localité et les données qui nous intéressent seront les boulangeries. Nous définissons 
les boulangeries et les supermarchés comme des points de vente de pain, puisque les deux 
produisent et vendent du pain eux-mêmes. Maintenant que tout devrait être clair, commençons!

Le moyen le plus simple et le plus rapide d'importer des données OpenStreetMap 
dans QGIS est d'utiliser un overpass turbo.
Cette méthode convient aussi bien aux débutants qu'aux avancés.
Visitez d'abord le site Web Overpass-Turbo à l'adresse suivante : http://overpass-turbo.osm.ch/.

Lorsque vous visitez le site Web pour la première fois, il ressemble à ceci:

.Page d'accueil de Overpass-Turbo
image::osm_editieren/osm-daten_beziehen/startseite.PNG[]

Cliquez sur le bouton rouge "Assistant". 
L'assistant permet de créer facilement des requêtes de dépassement. 
Comme nous recherchons des points de vente de pain par exemple, nous recherchons 
des boulangeries et des supermarchés. En tant que village, nous prenons Uster. 
La requête ressemble à ceci (`boulangerie ou supermarché à Uster`):

.Requête de l'assistant Turbo du viaduc
image::osm_editieren/osm-daten_beziehen/wizardAbfrage.PNG["Wizard-Abfrage", 280, 240]

Après avoir cliqué sur "Construire et exécuter une requête", vous obtiendrez ce qui suit:

.Résultat de la requête de l'assistant
image::osm_editieren/osm-daten_beziehen/resultat.PNG[]

Le résultat ci-dessus peut également être simplifié en remplaçant les `nodes`, 
les `ways` et les `relations` par `nwr` (=nodes/ways/relations).
Dans le coin inférieur droit, vous pouvez voir les différents objets marqués en rouge. 
Nous avons 23 POI et 5 polygones. Puisque nous ne voulons que des POI, nous pourrions 
utiliser `out center;` pour transformer toutes les zones et chemins en points.
La nouvelle requête devrait ressembler à ceci.

[source,overpass]
----
[out:json][timeout:25];
{{geocodeArea:Uster}}->.searchArea;
(
  nwr["shop"="bakery"](area.searchArea);
  nwr["shop"="supermarket"](area.searchArea);
);
out center;
----

Si nous copions maintenant les lignes du haut et les collons et les exécutons 
dans Overpass-Turbo comme une requête, nous obtenons ce qui suit :

.Résultat révisé
image::osm_editieren/osm-daten_beziehen/resultatNeu.PNG[]

Nous voyons maintenant dans le coin inférieur droit que les objets affichés ne sont que des POI.
Nous avons maintenant 28 POI et 0 polygone, parce que nous avons converti les 5 polygones en POI 
par `out center` et Overpass a ajouté ces 5 nouveaux POI aux 23 POI existants.

Nous devons maintenant enregistrer la requête sous GeoJSON. Pour ce faire, 
cliquez sur "Exporter" dans le coin supérieur gauche de "Assistant".
La fenêtre qui apparaît nous donne différentes options d'exportation: 
Nous choisissons celui du haut, c'est-à-dire "Télécharger/copier en tant que GeoJSON".

.Exportation d'Overpass
image::osm_editieren/osm-daten_beziehen/overpass_export.PNG["Overpass-Export-Dialog", 290, 395]

Nous insérons maintenant le fichier GeoJSON téléchargé dans le panneau de 
calques sur le côté gauche de QGIS en utilisant le glisser-déposer.
De plus, nous renommons la couche de manière appropriée, par exemple "Sorties de pain".

Notre QGIS ressemble maintenant à ceci :

.GeoJSON importé dans QGIS
image::osm_editieren/osm-daten_beziehen/brotverkaufsstellen_QGIS.PNG[]

Comme vous l'avez probablement remarqué, une couche standard OSM est utilisée 
ici comme arrière-plan pour présenter plus clairement les données.
Nous supposons que vous n'avez pas celui-ci, mais ce n'est pas si mal, 
car ce n'est pas absolument nécessaire. 
Ainsi, vous pouvez continuer sans la couche standard OSM comme arrière-plan.

Enfin, nous voulons changer le système de coordonnées des données importées 
de GeoJSON dans QGIS et les enregistrer sous forme de GeoPackage.
Pour ce faire, cliquez avec le bouton droit de la souris sur le calque, allez 
dans "Exporter" et sélectionnez l'entrée supérieure "Enregistrer la fonction sous...". 
Nous changeons le KBS en "EPSG:2056 - CH1903+/LV95" et donnons un nom au fichier.
Nous laissons le format comme GéoPackage et cliquons sur "OK".

Ci-dessous vous pouvez voir la fenêtre d'exportation:

.Exporter sous forme de GeoPackage
image::osm_editieren/osm-daten_beziehen/brotverkaufsstellen_gpkg.PNG["brotverkaufsstellen_gpkg", 480, 376]

Très bien, vous avez réussi à importer des données OpenStreetMap dans QGIS et 
à les enregistrer sous un nouveau format.
L'autre façon d'importer des données OpenStreetMap dans QGIS est d'utiliser 
le plugin QuickOSM, qui est expliqué ci-dessous. 
Si vous n'êtes pas intéressé ou si vous l'avez déjà lu, vous pouvez passer aux 
chapitres "Fusionner les calques de polygone avec les calques de points dans QGIS" 
ou "Filtrer les objets avec QGIS ou Affichage basé sur des règles".

== Importez des données OpenStreetMap directement dans QGIS avec le plugin QuickOSM

Voyons maintenant une autre façon d'importer et de gérer les 
données OpenStreetMap dans QGIS.
Il est préférable de supprimer le calque précédemment créé et de 
recommencer à zéro pour éviter toute confusion.

.QGIS
image::osm_editieren/osm-daten_beziehen/osm_in_qgis.PNG[]

Tout d'abord, nous installons le plugin QuickOSM, qui peut être 
utilisé pour créer des requêtes directement dans QGIS.
Pour ce faire, nous allons dans "Extensions" dans la barre de 
menu supérieure et ensuite dans "Gérer et installer les extensions...".
Entrez QuickOSM dans le champ de recherche et comme il n'y a qu'un seul 
plugin sous ce nom, vous devriez voir le bon.
Cliquez maintenant sur "Installer l'extension" et vous êtes prêt à 
travailler avec le plugin.

L'image suivante montre l'installation du plugin:

.Installation QuickOSM
image::osm_editieren/osm-daten_beziehen/quick_osm.png[]

Ouvrons maintenant le plugin en cliquant sur "Vector" dans la barre de menu puis sur "Quick OSM". 
Ensuite, nous entrons la requête suivante pour rechercher des boulangeries à Uster:

.Demande de renseignements sur la boulangerie
image::osm_editieren/osm-daten_beziehen/quickOSM_bakery.PNG["Bakery-Abfrage", 500, 316]

Après l'exécution de la requête, nous effectuons une deuxième requête pour 
rechercher les supermarchés :

.Demande au supermarché
image::osm_editieren/osm-daten_beziehen/quickOSM_supermarket.PNG["Supermarket-Abfrage", 500, 316]

Vous devriez maintenant avoir les calques suivants:

.Résultats des requêtes QuickOSM
image::osm_editieren/osm-daten_beziehen/abfrage_ergebnisse.PNG[]

Ce chapitre est maintenant clos, bien qu'il soit généralement nécessaire de le retravailler. 
Ces opérations de finition sont décrites dans l'introduction du chapitre suivant.


== Divers outils Web pour télécharger les données OpenStreetMap

Dans ce chapitre, vous trouverez divers outils Web pour télécharger des données OpenStreetMap. 
Certains proposent des pays entiers, d'autres des sections définies par l'utilisateur. 
Les formats d'exportation sont différents et certains outils nécessitent un enregistrement. 
Tous sont accessibles gratuitement, mais sans aucune garantie de fonctionnement ininterrompu.

[NOTE]
====
Comme mentionné dans l'introduction, il n'existe pas de schéma de données "SIG" 
unique pour l'OSM et, par conséquent, pratiquement aucune exportation de 
l'OSM n'est la même que l'autre. 
Il est donc important de consulter la documentation respective des outils web.
====

Ensuite, il y a généralement du travail de post-traitement dans les SIG:

1. Limitez les géodonnées (couche) à la zone à afficher ou à analyser. 
2. Il y a souvent des objets OSM du même type - comme les boulangeries - où 
l'un apparaît dans la couche point et l'autre dans la couche polygone. Toutefois, 
vous voulez les gérer uniformément et convertir les objets planaires en objets 
ponctuels et les ajouter à la couche ponctuelle. 
3. Certaines géodonnées (couches) contiennent des objets de différents types, 
par exemple magasin de type boulangerie et type supermarché. 
On aimerait les analyser et/ou les représenter filtrées.

Pour le premier problème, nous nous référons au menu QGIS "Outils 
de géotraitement" et à l'algorithme "Crop". 
Cet algorithme nécessite la spécification d'une couche de superposition, 
un périmètre, qui est généralement une limite administrative (p. ex. Uster). 

[NOTE]
====
Extraction des limites administratives comme GeoJSON: 
Recherchez d'abord le "Relation ID" dans OpenStreetMap, http://www.openstreetmap.org/relation/1682225[Uster].
Vous voyez maintenant l'entrée "wikidata Q64032" sur la barre latérale gauche. 
Avec ces informations, nous créons la requête suivante :

    [out:json][timeout:25];
    (
        // query part for: “wikidata=Q64032”
        relation["wikidata"="Q64032"];
    );
    out body;
    >;
    out skel qt;

Rendez-vous ensuite sur http://overpass-turbo.osm.ch/, entrez la requête et cliquez sur "Exécuter".
Exportez ensuite un fichier GeoJSON (par exemple uster.geojson) depuis Overpass-Turbo.
====

Aux deux autres problèmes la note suivante:

[NOTE]
====
Post-traitement des géodonnées: 
Si vous voulez savoir comment convertir des couches de polygones en 
couches de points, consultez le chapitre "Fusionner des couches de 
polygones avec des couches de points dans QGIS" ci-dessous. 
Si vous souhaitez apprendre à filtrer des objets, passez au chapitre 
"Filtrage d'objets avec QGIS ou affichage basé sur des règles".
====

=== OSM.org

Sur https://osm.org[OSM.org], vous pouvez également télécharger des données.
Ceux-ci ne peuvent être obtenus que sous forme de sections rectangulaires (bounding box) 
et jusqu'à un maximum de 50.000 nœuds, et également uniquement au format `OSM XML`.
Mais les données sont à jour.

Pour télécharger des données dans OSM, vous n'avez pas besoin d'un compte. 
Cliquez simplement sur le bouton "Exporter" dans le coin supérieur gauche et une barre 
latérale apparaîtra sur la gauche. Vous pouvez maintenant voir la boîte de délimitation avec les coordonnées. 
La Bounding Box contient toute la carte OSM actuellement visible. Les coordonnées 
changent lorsque vous déplacez la carte ou faites un zoom avant ou arrière. 
Cependant, si vous ne souhaitez pas exporter toute la carte visible, mais seulement 
une section, cliquez sur "Sélectionner une autre zone manuellement" sous la zone de délimitation. 
Maintenant, vous ne pouvez exporter que la section dont vous avez vraiment besoin. Cliquez de nouveau 
sur "Exporter" dans la barre latérale et vous obtiendrez un fichier.osm que vous pourrez 
importer et modifier dans QGIS.

Enfin, notez les notes sur le post-traitement des géodonnées 
ci-dessus dans ce chapitre.

=== Téléchargements de Geofabrik

Le site Web de Geofabrik http://download.geofabrik.de/ offre des données OpenStreetMap 
pour des pays et des régions entiers, qui sont bien sûr librement utilisables.
Les données peuvent y être téléchargées sous forme de fichiers Shapefiles 
(`.shp.zip`) ou dans les formats spécifiques OSM `.osm.pbf` et `.osm.bz2`.

Les données sont divisées en régions individuelles. 
Si vous cliquez sur une région, les données des pays de cette région s'affichent. 
Selon le pays, vous pouvez également télécharger des extraits plus petits du pays. 
Si vous maintenez le pointeur de la souris sur une région ou un pays, vous 
verrez la zone correspondante sur la carte sur le côté droit du site. 
Les données de GeoFabrik sont mises à jour toutes les 24 heures avec les données d'OpenStreetMap. 
Cela signifie que si vous venez d'effectuer vos propres modifications dans OpenstreetMap, 
vous devez attendre au moins un jour qu'elles soient disponibles chez Geofabrik.
Assurez-vous des données que vous téléchargez, car certaines peuvent avoir une taille de plusieurs gigaoctets.

Shapefile est un format vectoriel SIG et donc structuré selon certaines 
couches ('classes de fonctionnalités'). 
Pour trouver certains objets, tels que les boulangeries 
(dans la balise OSM `shop=bakery`) ou les supermarchés (balise `shop=supermarket`) 
vous devez consulter la documentation du "Layered GIS Format" sur 
https://www.geofabrik.de/de/data/shapefiles.html[Geofabrik] - ou les données elles-mêmes.

Enfin, notez les notes sur le post-traitement des géodonnées 
ci-dessus dans ce chapitre.

=== Outil d'exportation HOT

L'équipe humanitaire OpenStreetMap Team (HOT) offre un service en ligne avec 
l'outil d'exportation HOT pour télécharger des données depuis OpenStreetMap.
Pour utiliser l'outil d'exportation HOT, vous avez besoin d'un compte utilisateur 
OpenStreetMap et d'une adresse e-mail valide pour être averti lorsque les données 
sont prêtes pour le téléchargement.
Après vous être connecté, vous verrez les points et onglets suivants:

1. Description de l'Export
2. Formats
3. Data
4. Summary 

Les tabulateurs 1 et 4 sont décrits plus en détail ci-dessous.

Tabulateur 1 "Description de l'Export" est utilisé pour décrire le fichier à exporter. 
L'image ci-dessous montre un exemple d'exportation de débouchés pour le pain à Uster.

.Outil d'exportation HOT onglet 1 "Description de l'exportation".
image::osm_editieren/osm-daten_beziehen/hotosm_tab1.PNG[]

Vous pouvez ensuite sélectionner les données que vous souhaitez télécharger 
de différentes manières.

Vous le pouvez aussi:

* Entrez une localité dans la recherche
* Spécification d'une boîte de délimitation avec coordonnées
* Télécharger la vue actuelle
* Dessinez vous-même une Bounding Box
* Dessiner un polygone
* Télécharger un polygone en tant que fichier GeoJSON

Pour les deux premières possibilités, seul le champ de recherche doit être utilisé. 
Vous pouvez y spécifier soit la ville désirée, soit une case de 
délimitation (ouest, sud, est, nord).

Pour dessiner une case ou un polygone de délimitation, appuyez sur 
le bouton _Dessiner_ sur le côté droit de la carte.
Pour télécharger la vue actuelle, appuyez sur le bouton _Cette vue_.
Si vous voulez télécharger un fichier GeoJSON, vous pouvez le 
faire avec le bouton _Importer_.

[NOTE]
====
A ce stade, un petit tour d'horizon sur la création d'un fichier GeoJSON.

http://geojson.io est un site bien connu qui vous permet d'éditer GeoJSON.

L'outil d'exportation HOT n'attend que des objets GeoJSON simples (pas de 
FeatureCollection), c'est-à-dire un type de polygone et une liste de coordonnées.

Les fichiers GeoJSON de geojson.io et d'autres sources doivent donc être adaptés manuellement.
Ouvrez donc le fichier GeoJSON dans un éditeur de texte et simplifiez la structure en 
un seul objet polygone GeoJSON similaire à ce qui suit:

.Objet polygone GeoJSON unique pour l'outil d'exportation HOT
image::osm_editieren/osm-daten_beziehen/json_format.png["json_format", 270, 350]
====

Continuons avec l'outil d'exportation HOT.
Dans l'onglet 2, vous choisissez le format, par exemple GéoPackage.

.Outil d'exportation HOT onglet 2 "Formats".
image::osm_editieren/osm-daten_beziehen/hotosm_tab2.PNG[]

Avec l'onglet 3 "Data", vous passez au registre "YAML" et insérez ce qui suit:

[source,yaml]
----
gastronomy:
 types:
   - points
   - polygons
 select:
   - name
   - addr:city
   - amenity
   - opening_hours
 where: amenity IN ('restaurant','fast_food','cafe','bar','pub')
bakeries:
 types:
   - points
   - polygons
 select:
   - name
   - addr:city
   - shop
   - opening_hours
 where: shop IN ('bakery','supermarket')
----

CAUTION: YAML est un langage de balisage simplifié basé sur XML. 
La syntaxe YAML utilise des indentations. 
N'utilisez que des espaces (pas d'onglets). 
Avec le site http://www.yamllint.com/[YAML Lint] vous pouvez valider YAML.

Tout ça ressemblera à ça:

.Outil d'exportation HOT onglet 3 "Données".
image::osm_editieren/osm-daten_beziehen/hotosm_tab3.PNG[]

Une fois que vous avez fait cela, nous pouvons presque exporter 
la requête sous forme de GéoPackage. 
Nous passons donc à l'onglet 4 "Summary". 
La dernière chose à faire avant d'exporter est de chercher "Uster" 
sur le côté droit de la carte. Ensuite, il sera agrandi:

.Outil d'exportation HOT Uster
image::osm_editieren/osm-daten_beziehen/hotosm_uster.PNG[]

Une fois que vous avez fait cela, vous pouvez cliquer sur le bouton 
"Créer une exportation" (voir ci-dessous).

.Outil d'exportation HOT onglet 4 "Résumé".
image::osm_editieren/osm-daten_beziehen/hotosm_tab4.PNG[]

Enfin, notez les notes sur le post-traitement des géodonnées 
ci-dessus dans ce chapitre.

=== OSMaxx

Avec OSMaxx, des extraits d'OpenStreetMap peuvent être téléchargés 
dans différents formats SIG, pas seulement par pays, mais dans le format souhaité.

Pour utiliser OSMaxx, vous avez besoin d'un compte OSM avec une adresse e-mail valide.

Les extraits existants peuvent être téléchargés sous _Existing Excerpt / Country_. 
Vous pouvez choisir dans quel format le fichier doit être téléchargé, quel système 
de coordonnées doit être utilisé et combien de détails doivent être affichés.

Sous _Nouvel extrait_, vous pouvez sélectionner vos propres zones 
d'OpenStreetMap que vous souhaitez télécharger.
Vous pouvez dessiner un rectangle ou un polygone sur la carte. 
Là encore, vous pouvez choisir dans quel format le fichier doit 
être téléchargé, quel système de coordonnées doit être utilisé et 
combien de détails doivent être affichés.

L'exportation des données prend au moins 45 minutes environ. 

Si vous avez choisi un format SIG et que vous voulez savoir si et où il y a 
des boulangeries, par exemple, allez sur la page "A propos" d'OSMaxx, 
où le schéma de données est documenté.

Enfin, notez les notes sur le post-traitement des géodonnées 
ci-dessus dans ce chapitre.

=== BBBike

BBBike https://extract.bbbike.org/ offre les données de Planet.osm 
dans de nombreux formats de fichiers différents.

Seule une boîte de délimitation doit être créée pour l'extraction. 
La boîte de délimitation peut avoir une taille maximale de 
24'000'000 km², soit 512 mégaoctets comme fichier. 
Après avoir saisi une adresse e-mail valide et attribué un nom à 
l'extraction, vous pouvez cliquer sur le bouton _Extract_. Vous recevrez 
une notification par courriel avec le lien de téléchargement.

Si vous voulez en savoir plus sur BBBike, veuillez consulter 
le lien suivant dans la documentation:

* https://www.bbbike.org/api.html

Enfin, notez les notes sur le post-traitement des géodonnées 
ci-dessus dans ce chapitre.

== Fusion des calques de polygone avec les calques de points dans QGIS

Avec l'OSM, il arrive à maintes reprises qu'un objet - comme une 
boulangerie - soit capturé comme un point et parfois comme un 
polygone de contour de bâtiment. 
C'est pourquoi il arrive que vous obteniez des couches de polygones 
dans le SIG avec les mêmes types d'objets que dans la couche de points. 
En fait, cependant, on veut s'adresser à tous les objets uniformément et tout à la fois.

Ainsi, étant donné une couche polygonale et une couche de points, nous devons 
convertir les polygones de la couche polygonale en points et pouvons 
ensuite les intégrer dans la couche de points. 

Pour ce faire, allez dans "Geometry Tools" dans le menu "Vector" 
du QGIS et ensuite dans "Centroids...". 
Après cela, le QGIS devrait ressembler à ceci, où les noms des 
nouvelles couches ont déjà été renommés:

.Couche polygonale convertie
image::osm_editieren/osm-daten_beziehen/vier_punktelayer.PNG[]

Comme nous avons maintenant plusieurs couches de points, nous devons les fusionner. 
Une telle fusion ne fonctionne que si toutes les couches ont le même 
type de données géométriques. 
Allez dans "Data Management Tools" dans le menu "Vector" du QGIS puis dans "Merge Vector Layers". 
Sélectionnez les quatre couches dans la boîte de dialogue:

.Fusionner plusieurs calques en un seul calque
image::osm_editieren/osm-daten_beziehen/vektorlayer_zusammenfuehren.PNG["vektorlayer_zusammenfuehren", 480, 317]

Après avoir fait ceci, vous verrez un nouveau calque sur la gauche. 
Maintenant vous n'avez plus besoin des anciens calques et vous pouvez les supprimer. 
Le nouveau calque porte le nom "Fusionné". 
Ça aurait du sens si vous l'aviez rebaptisé "Bread Stores". 
Ci-dessous vous pouvez voir le résultat final de cette seconde méthode, 
où la couche n'a pas (encore) été renommée: 

.Résultat final
image::osm_editieren/osm-daten_beziehen/brotverkaufsstellen_QGIS.PNG[]


== Filtrage ou affichage d'objets basé sur des règles avec QGIS

Après avoir reçu les données OpenStreetMap dans la section souhaitée, 
il se peut que vous ne vouliez pas travailler avec toutes les données. 
Il existe deux méthodes fondamentalement différentes pour obtenir 
un sous-ensemble de données: 
D'une part, la source de données peut être filtrée selon des critères personnalisés. 
D'autre part, vous pouvez afficher les données en fonction des règles, de 
sorte que seules les données conformes aux règles soient affichées.

Dans ce qui suit, nous examinons les deux méthodes. 
L'exemple des points de vente de pain reste le même. 
Les points de vente de pain contiennent à la fois des "boulangeries" et des "supermarchés". 
Mais maintenant, nous voulons seulement traiter et afficher les "boulangeries" dans QGIS.

=== Filtrer les objets avec QGIS

Dans QGIS, il existe deux options de dialogue pour filtrer les objets: 
Soit vous allez dans "Layer" dans le menu et sélectionnez ensuite 
"Filter...". (alors que le calque désiré est sélectionné). 
Vous pouvez aussi cliquer avec le bouton droit de la souris sur le calque désiré et aller dans "Filtrer...". 
Une boîte de dialogue avec le titre "Création d'une requête" s'ouvre alors. 
Dans cette fenêtre, vous pouvez voir ce qui suit: 

* Champs: Une liste de tous les attributs que contient le calque sélectionné.
* Valeurs: Les valeurs de l'attribut sélectionné qui apparaissent dans le 
calque (pour afficher certaines valeurs, cliquez sur le bouton "Sample")
* Opérateurs: Opérateurs logiques pour relier des champs et des valeurs.
* Expression de filtre spécifique au fournisseur de données: 
expression SQL pour filtrer les attributs et les valeurs

Dans le champ de saisie "Expression de filtre spécifique au 
fournisseur de données", nous introduisons ce qui suit:

[source,sql]
----
"shop"='bakery'
----

"shop" est l'attribut (notez les guillemets doubles). 
boulangerie' est la valeur (notez les guillemets simples). 

La fenêtre devrait ressembler à ceci:

.Filtrer les objets
image::osm_editieren/osm-daten_beziehen/filtern.PNG["Objekte filtern", 490, 407]

Cliquez maintenant sur "OK". 
Vous devriez maintenant recevoir le message qu'environ 10 objets 
ont été trouvés qui ont la valeur " boulangerie " dans l'attribut " boutique ".
Nous ne voyons que les objets qui répondent au critère de filtrage. 
Tous les autres objets ne font plus partie de la source de données de la couche:

.Boulangeries à Uster
image::osm_editieren/osm-daten_beziehen/uster_bäckereien.PNG[]

Comme vous pouvez le voir ci-dessus, vous devez maintenant 
renommer le calque "Boulangeries" en "Boulangeries".

=== Affichage des objets basé sur des règles avec QGIS

La représentation basée sur des règles consiste à afficher tous les objets 
qui remplissent un critère à partir d'une source de données de rang. 
On parle aussi de "représentation guidée par les données".
Cette expression, qui doit être filtrée par, fait partie de la représentation 
(symbologie) et non de la couche comme avec l'autre méthode. 

L'affichage basé sur des règles peut également être utilisé pour 
_ne pas_ afficher les valeurs individuelles. 
Dans notre exemple, nous voulons en profiter pour montrer uniquement les 
boulangeries ('boulangerie') et non les supermarchés ('supermarché'). 
Pour ce faire, cliquez avec le bouton droit de la souris sur le calque 
et cliquez sur l'entrée inférieure "Propriétés...". 
Dans le menu de gauche, cliquez sur "Affichage" (troisième entrée). 
Maintenant, ça devrait ressembler à ça pour vous:

.Représentation d'objets
image::osm_editieren/osm-daten_beziehen/single_symbol.PNG["single_symbol_menu", 590, 357]

Dans l'image du haut, vous voyez une marque rouge autour de l'entrée "Symbole unique". 
C'est parce que nous sommes en train de changer cette entrée en "basée sur les règles". 
Auparavant, tous les objets étaient traités de la même manière (non différenciés) 
et donc affichés de la même manière, donc "symbole unique". 
Maintenant que nous avons sélectionné "Rule-based", nous pouvons définir des règles 
(expressions) pour affecter des objets à différents symboles en fonction de valeurs d'attributs.

.Objets sans filtre
image::osm_editieren/osm-daten_beziehen/kein_Filter.PNG["Objekte ohne Filter", 630, 381]

Dans l'image ci-dessus, vous pouvez voir que nous avons une entrée. 
Cette entrée contient les 28 objets, et nous voyons qu'aucune règle 
n'est définie sur ces objets. 
C'est pourquoi nous cliquons deux fois sur l'entrée. 
Dans le champ de texte à côté de "Filtre", nous entrons à nouveau ce qui suit:

    "shop"='bakery'

C'est ce qu'on va croire:

.Boîte de dialogue Modifier une règle
image::osm_editieren/osm-daten_beziehen/edit_rule.PNG["Edit-Rule-Dialog", 319, 260]

Cliquez maintenant sur "OK". 
Nous voyons que l'entrée ne dit plus "(pas de filtre)", mais `"shop"='bakery'``. 
Cliquez maintenant sur "Appliquer", puis à nouveau sur "OK".  
Dans le SIGQ, cela devrait maintenant ressembler à ceci :

.Boulangeries à Uster
image::osm_editieren/osm-daten_beziehen/uster_bäckereien_nach_regeln.PNG[]

Nous voyons que nous avons encore 28 objets. 
Cependant, seuls les 10 objets qui remplissent la règle, 
c'est-à-dire uniquement les boulangeries, nous sont présentés. 
Vous l'avez peut-être déjà remarqué, parce que contrairement à 
cela le nombre d'objets change avec le filtre simple (voir ci-dessus). 
Non seulement les 10 boulangeries y sont affichées, mais le nombre 
d'objets est également réduit à 10. 
C'est une différence particulière entre le filtrage 
"normal" et la représentation basée sur des règles. 
Examinons une autre possibilité.

En supposant que nous voulons toujours afficher tous les objets et seulement une 
partie d'entre eux, nous pouvons simplement utiliser une couleur différente 
pour toutes les boulangeries.
Supprimer la règle que nous avons appliquée aux objets précédemment. 
Ensuite, nous partons de la vue suivante:

.Objets sans filtre
image::osm_editieren/osm-daten_beziehen/kein_Filter.PNG["Objekte ohne Filter", 630, 381]

En bas à gauche, cliquez sur le signe plus. 
Maintenant que nous avons copié nos objets, appliquons la règle à cette copie. 
Saisissez à nouveau ce qui suit et cliquez sur "OK":

.Boîte de dialogue Modifier une règle
image::osm_editieren/osm-daten_beziehen/edit_rule.PNG["Edit-Rule-Dialog", 319, 260]

Cliquez maintenant sur "Appliquer" puis sur "OK". 
Il devrait maintenant ressembler à ceci dans QGIS:

.Boulangeries avec code couleur (rose)
image::osm_editieren/osm-daten_beziehen/brotverkaufsstellen_regelbasiert.PNG[]

La couche "Sorties de pain" doit maintenant avoir deux groupes d'objets différents. 
D'une part, nous voyons les 28 points de vente de pain en orange. 
D'autre part, nous avons maintenant un nouveau (sous-)groupe avec 10 objets, 
à savoir nos boulangeries en rose.

Ceci conclut ce chapitre ou cette feuille de travail et vous laisse le soin 
d'étendre les calques et l'ensemble du projet QGIS et d'améliorer l'affichage.

include::../../snippets/quellenangabe.adoc[]