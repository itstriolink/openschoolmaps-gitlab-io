= Obtenir des données OpenStreetMap et les utiliser avec QGIS 3
OpenSchoolMaps.ch -- Freie Lernmaterialien zu freien Geodaten und Karten
:xrefstyle: short
:imagesdir: ../../bilder/
include::../../snippets/suppress_title_page.adoc[]

*Un guide pour les intéressés, pour les élèves et pour les instructeurs/enseignants*

== Aperçu

.Objectif
Le but de ce guide est de montrer comment obtenir des données 
OpenStreetMap et les utiliser dans QGIS 3.

.Public cible
Toute personne intéressée par la création de sa propre carte (carte web en ligne, 
carte imprimable) ou par l'analyse de géodonnées disponibles gratuitement dans le monde entier.
Si vous ne connaissez pas encore OpenStreetMap, vous devriez lire les feuilles de travail 
"Utilisation du site OSM.org au quotidien" et "Recherche des données OpenStreetMap".

.Planification
Cette feuille de travail exige un temps différent en fonction de 
vos connaissances antérieures, car vous pouvez sauter des sections 
individuelles si vous n'êtes intéressé que par certains sujets ou solutions.

.Structure
Les sujets suivants seront abordés:

* Introduction avec des explications sur OpenStreetMap et les systèmes 
d'information géographique ainsi que sur les formats de fichiers courants.
* Extraction des données OpenStreetMap avec Overpass 
* Importez des données OpenStreetMap directement dans QGIS avec le plugin QuickOSM
* Divers outils Web pour télécharger les données OpenStreetMap
* Fusion des calques de polygone avec les calques de points dans QGIS
* Filtrage ou affichage d'objets basé sur des règles avec QGIS

Nous vous recommandons de lire au moins l'introduction et le chapitre 
"Extraction des données OpenStreetMap avec Overpass".

[NOTE]
====
Ce tutoriel traite de l'utilisation des données existantes dans OpenStreetMap.
Si vous souhaitez enregistrer des données vous-même, vous pouvez utiliser les 
feuilles de travail "Edit OpenStreetMap" et "Create a thematic online map with 
uMap" ainsi que https://learnosm.org/de/ pour plus d'informations.
====

== Initiation

Les données d'OpenStreetMap sont disponibles dans différents formats de données.
C'est pourquoi nous allons d'abord expliquer plus en détail certains de ces formats de fichiers.

=== OpenStreetMap et les systèmes d'information géographique

La géométrie des objets dans OpenStreetMap (OSM) est stockée en interne sous forme 
de structures topologiques (nœuds, voies) et les attributs des objets sous forme 
de tags (paires clé-valeur) ne sont que partiellement structurés.
Ce schéma de données, qui peut être étendu à volonté, doit d'abord être converti 
pour les systèmes d'information géographique (SIG) et leurs formats.
Il n'existe pas de schéma de données SIG unique pour l'OSM.
Pratiquement aucune exportation de l'OSM n'est donc identique à l'autre.

=== Formats de fichiers

Fondamentalement, on peut faire la distinction entre les formats SIG propres à 
l'OSM et les formats SIG analysables.

* Les formats spécifiques à l'OSM sont principalement OSM XML et OSM PBF.
* Les formats compatibles SIG sont GeoJSON, GeoPackage, Shapefiles et GeoJSON.
* Les autres formats vectoriels SIG sont : KML et GPX pour l'échange de données GPS.
* D'autres formats qui ne peuvent pas être analysés plus avant sont les formats 
d'images/raster tels que PNG, JPEG et PDF.

[NOTE]
====
Ce qui suit décrit les différentes méthodes d'importation des 
données OpenStreetMap dans QGIS. 
La première méthode fonctionne avec Overpass-Turbo, un service web pour 
interroger les données OpenStreetMap. 
Nous vous recommandons d'examiner d'abord cette méthode, car c'est la plus 
efficace de toutes les méthodes présentées. 
La seconde méthode est basée sur QuickOSM, un plugin pour QGIS qui vous 
permet de créer des requêtes OpenStreetMap directement dans QGIS. 
C'est à vous de décider quelle méthode vous voulez utiliser. 

Après les deux méthodes d'importation, différents outils Web sont présentés 
pour télécharger les données OpenStreetMap. 

Dans les deux derniers chapitres, vous apprendrez comment éditer 
les géodonnées importées dans QGIS.
====

== Extraction des données OpenStreetMap avec Overpass

Avant d'en venir aux tâches, nous devons clarifier certaines ambiguïtés. 
Puisque nous travaillons avec des géodonnées, il serait logique de s'entendre sur un emplacement. 
Nous avons aussi besoin de savoir quel type de données nous voulons traiter pour cette ville. 
C'est pourquoi, dans toutes les sections suivantes, nous utiliserons Uster (canton ZH) 
comme localité et les données qui nous intéressent seront les boulangeries. Nous définissons 
les boulangeries et les supermarchés comme des points de vente de pain, puisque les deux 
produisent et vendent du pain eux-mêmes. Maintenant que tout devrait être clair, commençons!

Le moyen le plus simple et le plus rapide d'importer des données OpenStreetMap 
dans QGIS est d'utiliser un overpass turbo.
Cette méthode convient aussi bien aux débutants qu'aux avancés.
Visitez d'abord le site Web Overpass-Turbo à l'adresse suivante : http://overpass-turbo.osm.ch/.

Lorsque vous visitez le site Web pour la première fois, il ressemble à ceci:

.Page d'accueil de Overpass-Turbo
image::osm_editieren/osm-daten_beziehen/startseite.PNG[]

Cliquez sur le bouton rouge "Assistant". 
L'assistant permet de créer facilement des requêtes de dépassement. 
Comme nous recherchons des points de vente de pain par exemple, nous recherchons 
des boulangeries et des supermarchés. En tant que village, nous prenons Uster. 
La requête ressemble à ceci (`boulangerie ou supermarché à Uster`):

.Requête de l'assistant Turbo du viaduc
image::osm_editieren/osm-daten_beziehen/wizardAbfrage.PNG["Wizard-Abfrage", 280, 240]

Après avoir cliqué sur "Créer et exécuter la requête", vous obtiendrez ce qui suit:

.Résultat de la requête de l'assistant
image::osm_editieren/osm-daten_beziehen/resultat.PNG[]

Le résultat ci-dessus peut également être simplifié en remplaçant les `nodes`, 
les `ways` et les `relations` par `nwr` (=nodes/ways/relations).
Dans le coin inférieur droit, vous pouvez voir les différents objets marqués en rouge. 
Nous avons 22 POI et 5 polygones. Puisque nous ne voulons que des POI, nous pourrions 
utiliser `out center;` pour transformer toutes les zones et chemins en points.
La nouvelle requête devrait ressembler à ceci.

[source,overpass]
----
[out:json][timeout:25];
{{geocodeArea:Uster}}->.searchArea;
(
  nwr["shop"="bakery"](area.searchArea);
  nwr["shop"="supermarket"](area.searchArea);
);
out center;
----

Si nous copions maintenant les lignes du haut et les collons et les exécutons 
dans Overpass-Turbo comme une requête, nous obtenons ce qui suit :

.Résultat révisé
image::osm_editieren/osm-daten_beziehen/resultatNeu.PNG[]

Nous voyons maintenant dans le coin inférieur droit que les objets affichés ne sont que des POI.
Nous avons maintenant 27 POI et 0 polygone, parce que nous avons converti les 5 polygones en POI 
par `out center` et Overpass a ajouté ces 5 nouveaux POI aux 22 POI existants.

Nous devons maintenant enregistrer la requête sous GeoJSON. Pour ce faire, 
cliquez sur "Exporter" dans le coin supérieur gauche de "Assistant".
La fenêtre qui apparaît nous donne différentes options d'exportation: 
Nous choisissons celui du haut, c'est-à-dire "Enregistrer sous GeoJSON".

.Exportation d'Overpass
image::osm_editieren/osm-daten_beziehen/overpass_export.PNG["Overpass-Export-Dialog", 290, 395]

Nous insérons maintenant le fichier GeoJSON téléchargé dans le panneau de 
calques sur le côté gauche de QGIS en utilisant le glisser-déposer.
De plus, nous renommons la couche de manière appropriée, par exemple "Sorties de pain".

Notre QGIS ressemble maintenant à ceci :

.GeoJSON importé dans QGIS
image::osm_editieren/osm-daten_beziehen/brotverkaufsstellen_QGIS.PNG[]

Comme vous l'avez probablement remarqué, une couche standard OSM est utilisée 
ici comme arrière-plan pour présenter plus clairement les données.
Nous supposons que vous n'avez pas celui-ci, mais ce n'est pas si mal, 
car ce n'est pas absolument nécessaire. 
Ainsi, vous pouvez continuer sans la couche standard OSM comme arrière-plan.

Enfin, nous voulons changer le système de coordonnées des données importées 
de GeoJSON dans QGIS et les enregistrer sous forme de GeoPackage.
Pour ce faire, cliquez avec le bouton droit de la souris sur le calque, allez 
dans "Exporter" et sélectionnez l'entrée supérieure "Enregistrer la fonction sous...". 
Nous changeons le KBS en "EPSG:2056 - CH1903+/LV95" et donnons un nom au fichier.
Nous laissons le format comme GéoPackage et cliquons sur "OK".

Ci-dessous vous pouvez voir la fenêtre d'exportation:

.Exporter sous forme de GeoPackage
image::osm_editieren/osm-daten_beziehen/brotverkaufsstellen_gpkg.PNG["brotverkaufsstellen_gpkg", 480, 376]

Très bien, vous avez réussi à importer des données OpenStreetMap dans QGIS et 
à les enregistrer sous un nouveau format.
L'autre façon d'importer des données OpenStreetMap dans QGIS est d'utiliser 
le plugin QuickOSM, qui est expliqué ci-dessous. 
Si vous n'êtes pas intéressé ou si vous l'avez déjà lu, vous pouvez passer aux 
chapitres "Fusionner les calques de polygone avec les calques de points dans QGIS" 
ou "Filtrer les objets avec QGIS ou Affichage basé sur des règles".

== Importez des données OpenStreetMap directement dans QGIS avec le plugin QuickOSM

Voyons maintenant une autre façon d'importer et de gérer les 
données OpenStreetMap dans QGIS.
Il est préférable de supprimer le calque précédemment créé et de 
recommencer à zéro pour éviter toute confusion.

.QGIS
image::osm_editieren/osm-daten_beziehen/osm_in_qgis.PNG[]

Tout d'abord, nous installons le plugin QuickOSM, qui peut être 
utilisé pour créer des requêtes directement dans QGIS.
Pour ce faire, nous allons dans "Extensions" dans la barre de 
menu supérieure et ensuite dans "Gérer et installer les extensions...".
Entrez QuickOSM dans le champ de recherche et comme il n'y a qu'un seul 
plugin sous ce nom, vous devriez voir le bon.
Cliquez maintenant sur "Installer l'extension" et vous êtes prêt à 
travailler avec le plugin.

L'image suivante montre l'installation du plugin:

.Installation QuickOSM
image::osm_editieren/osm-daten_beziehen/quick_osm.png[]

Ouvrons maintenant le plugin en cliquant sur "Vector" dans la barre de menu puis sur "Quick OSM". 
Ensuite, nous entrons la requête suivante pour rechercher des boulangeries à Uster:

.Demande de renseignements sur la boulangerie
image::osm_editieren/osm-daten_beziehen/quickOSM_bakery.PNG["Bakery-Abfrage", 500, 316]

Après l'exécution de la requête, nous effectuons une deuxième requête pour 
rechercher les supermarchés :

.Demande au supermarché
image::osm_editieren/osm-daten_beziehen/quickOSM_supermarket.PNG["Supermarket-Abfrage", 500, 316]

Vous devriez maintenant avoir les calques suivants:

.Résultats des requêtes QuickOSM
image::osm_editieren/osm-daten_beziehen/abfrage_ergebnisse.PNG[]

Ce chapitre est maintenant clos, bien qu'il soit généralement nécessaire de le retravailler. 
Ces opérations de finition sont décrites dans l'introduction du chapitre suivant.


== Divers outils Web pour télécharger les données OpenStreetMap

Dans ce chapitre, vous trouverez divers outils Web pour télécharger des données OpenStreetMap. 
Certains proposent des pays entiers, d'autres des sections définies par l'utilisateur. 
Les formats d'exportation sont différents et certains outils nécessitent un enregistrement. 
Tous sont accessibles gratuitement, mais sans aucune garantie de fonctionnement ininterrompu.

[NOTE]
====
Comme mentionné dans l'introduction, il n'existe pas de schéma de données "SIG" 
unique pour l'OSM et, par conséquent, pratiquement aucune exportation de 
l'OSM n'est la même que l'autre. 
Il est donc important de consulter la documentation respective des outils web.
====

Ensuite, il y a généralement du travail de post-traitement dans les SIG:

1. Limitez les géodonnées (couche) à la zone à afficher ou à analyser. 
2. Il y a souvent des objets OSM du même type - comme les boulangeries - où 
l'un apparaît dans la couche point et l'autre dans la couche polygone. Toutefois, 
vous voulez les gérer uniformément et convertir les objets planaires en objets 
ponctuels et les ajouter à la couche ponctuelle. 
3. Certaines géodonnées (couches) contiennent des objets de différents types, 
par exemple magasin de type boulangerie et type supermarché. 
On aimerait les analyser et/ou les représenter filtrées.

Pour le premier problème, nous nous référons au menu QGIS "Outils 
de géotraitement" et à l'algorithme "Crop". 
Cet algorithme nécessite la spécification d'une couche de superposition, 
un périmètre, qui est généralement une limite administrative (p. ex. Uster). 

[NOTE]
====
Extraction des limites administratives comme GeoJSON: 
Recherchez d'abord le "Relation ID" dans OpenStreetMap, http://www.openstreetmap.org/relation/1682225[Uster].
Vous voyez maintenant l'entrée "wikidata Q64032" sur la barre latérale gauche. 
Avec ces informations, nous créons la requête suivante :

    [out:json][timeout:25];
    (
        // query part for: “wikidata=Q64032”
        relation["wikidata"="Q64032"];
    );
    out body;
    >;
    out skel qt;

Rendez-vous ensuite sur http://overpass-turbo.osm.ch/, entrez la requête et cliquez sur "Exécuter".
Exportez ensuite un fichier GeoJSON (par exemple uster.geojson) depuis Overpass-Turbo.
====

Aux deux autres problèmes la note suivante:

[NOTE]
====
Post-traitement des géodonnées: 
Si vous voulez savoir comment convertir des couches de polygones en 
couches de points, consultez le chapitre "Fusionner des couches de 
polygones avec des couches de points dans QGIS" ci-dessous. 
Si vous souhaitez apprendre à filtrer des objets, passez au chapitre 
"Filtrage d'objets avec QGIS ou affichage basé sur des règles".
====

=== OSM.org

Sur https://osm.org[OSM.org], vous pouvez également télécharger des données.
Ceux-ci ne peuvent être obtenus que sous forme de sections rectangulaires (bounding box) 
et jusqu'à un maximum de 50.000 nœuds, et également uniquement au format `OSM XML`.
Mais les données sont à jour.

Pour télécharger des données dans OSM, vous n'avez pas besoin d'un compte. 
Cliquez simplement sur le bouton "Exporter" dans le coin supérieur gauche et une barre 
latérale apparaîtra sur la gauche. Vous pouvez maintenant voir la boîte de délimitation avec les coordonnées. 
La Bounding Box contient toute la carte OSM actuellement visible. Les coordonnées 
changent lorsque vous déplacez la carte ou faites un zoom avant ou arrière. 
Cependant, si vous ne souhaitez pas exporter toute la carte visible, mais seulement 
une section, cliquez sur "Sélectionner une autre zone manuellement" sous la zone de délimitation. 
Maintenant, vous ne pouvez exporter que la section dont vous avez vraiment besoin. Cliquez de nouveau 
sur "Exporter" dans la barre latérale et vous obtiendrez un fichier.osm que vous pourrez 
importer et modifier dans QGIS.

Enfin, notez les notes sur le post-traitement des géodonnées 
ci-dessus dans ce chapitre.

=== Téléchargements de Geofabrik

Le site Web de Geofabrik http://download.geofabrik.de/ offre des données OpenStreetMap 
pour des pays et des régions entiers, qui sont bien sûr librement utilisables.
Les données peuvent y être téléchargées sous forme de fichiers Shapefiles 
(`.shp.zip`) ou dans les formats spécifiques OSM `.osm.pbf` et `.osm.bz2`.

Les données sont divisées en régions individuelles. 
Si vous cliquez sur une région, les données des pays de cette région s'affichent. 
Selon le pays, vous pouvez également télécharger des extraits plus petits du pays. 
Si vous maintenez le pointeur de la souris sur une région ou un pays, vous 
verrez la zone correspondante sur la carte sur le côté droit du site. 
Les données de GeoFabrik sont mises à jour toutes les 24 heures avec les données d'OpenStreetMap. 
Cela signifie que si vous venez d'effectuer vos propres modifications dans OpenstreetMap, 
vous devez attendre au moins un jour qu'elles soient disponibles chez Geofabrik.
Assurez-vous des données que vous téléchargez, car certaines peuvent avoir une taille de plusieurs gigaoctets.

Shapefile est un format vectoriel SIG et donc structuré selon certaines 
couches ('classes de fonctionnalités'). 
Pour trouver certains objets, tels que les boulangeries 
(dans la balise OSM `shop=bakery`) ou les supermarchés (balise `shop=supermarket`) 
vous devez consulter la documentation du "Layered GIS Format" sur 
https://www.geofabrik.de/de/data/shapefiles.html[Geofabrik] - ou les données elles-mêmes.

Enfin, notez les notes sur le post-traitement des géodonnées 
ci-dessus dans ce chapitre.

=== Outil d'exportation HOT

L'équipe humanitaire OpenStreetMap Team (HOT) offre un service en ligne avec 
l'outil d'exportation HOT pour télécharger des données depuis OpenStreetMap.
Pour utiliser l'outil d'exportation HOT, vous avez besoin d'un compte utilisateur 
OpenStreetMap et d'une adresse e-mail valide pour être averti lorsque les données 
sont prêtes pour le téléchargement.
Après vous être connecté, vous verrez les points et onglets suivants:

1. Description des exportations
2. Formats
3. Données
4. Récapitulatif 

Les tabulateurs 1 et 4 sont décrits plus en détail ci-dessous.

Tabulateur 1 "Exporter description" est utilisé pour décrire le fichier à exporter. 
L'image ci-dessous montre un exemple d'exportation de débouchés pour le pain à Uster.

.Outil d'exportation HOT onglet 1 "Description de l'exportation".
image::osm_editieren/osm-daten_beziehen/hotosm_tab1.PNG[]

Vous pouvez ensuite sélectionner les données que vous souhaitez télécharger 
de différentes manières.

Vous le pouvez aussi:

* Entrez une localité dans la recherche
* Spécification d'une boîte de délimitation avec coordonnées
* Télécharger la vue actuelle
* Dessinez vous-même une Bounding Box
* Dessiner un polygone
* Télécharger un polygone en tant que fichier GeoJSON

Pour les deux premières possibilités, seul le champ de recherche doit être utilisé. 
Vous pouvez y spécifier soit la ville désirée, soit une case de 
délimitation (ouest, sud, est, nord).

Pour dessiner une case ou un polygone de délimitation, appuyez sur 
le bouton _Dessiner_ sur le côté droit de la carte.
Pour télécharger la vue actuelle, appuyez sur le bouton _Cette vue_.
Si vous voulez télécharger un fichier GeoJSON, vous pouvez le 
faire avec le bouton _Importer_.

[NOTE]
====
A ce stade, un petit tour d'horizon sur la création d'un fichier GeoJSON.

http://geojson.io est un site bien connu qui vous permet d'éditer GeoJSON.

L'outil d'exportation HOT n'attend que des objets GeoJSON simples (pas de 
FeatureCollection), c'est-à-dire un type de polygone et une liste de coordonnées.

Les fichiers GeoJSON de geojson.io et d'autres sources doivent donc être adaptés manuellement.
Ouvrez donc le fichier GeoJSON dans un éditeur de texte et simplifiez la structure en 
un seul objet polygone GeoJSON similaire à ce qui suit:

.Objet polygone GeoJSON unique pour l'outil d'exportation HOT
image::osm_editieren/osm-daten_beziehen/json_format.png["json_format", 270, 350]

Continuons avec l'outil d'exportation HOT.
Dans l'onglet 2, vous choisissez le format, par exemple GéoPackage.

.Outil d'exportation HOT onglet 2 "Formats".
image::osm_editieren/osm-daten_beziehen/hotosm_tab2.PNG[]

Avec l'onglet 3 "Données", vous passez au registre "YAML" et insérez ce qui suit:

[source,yaml]
----
gastronomy:
 types:
   - points
   - polygons
 select:
   - name
   - addr:city
   - amenity
   - opening_hours
 where: amenity IN ('restaurant','fast_food','cafe','bar','pub')
bakeries:
 types:
   - points
   - polygons
 select:
   - name
   - addr:city
   - shop
   - opening_hours
 where: shop IN ('bakery','supermarket')
----

CAUTION: YAML est un langage de balisage simplifié basé sur XML. 
La syntaxe YAML utilise des indentations. 
N'utilisez que des espaces (pas d'onglets). 
Avec le site http://www.yamllint.com/[YAML Lint] vous pouvez valider YAML.

Tout ça ressemblera à ça:

.Outil d'exportation HOT onglet 3 "Données".
image::osm_editieren/osm-daten_beziehen/hotosm_tab3.PNG[]

Une fois que vous avez fait cela, nous pouvons presque exporter 
la requête sous forme de GéoPackage. 
Nous passons donc à l'onglet 4 "Résumé". 
La dernière chose à faire avant d'exporter est de chercher "Uster" 
sur le côté droit de la carte. Ensuite, il sera agrandi:

.Outil d'exportation HOT Uster
image::osm_editieren/osm-daten_beziehen/hotosm_uster.PNG[]

Une fois que vous avez fait cela, vous pouvez cliquer sur le bouton 
"Créer une exportation" (voir ci-dessous).

.Outil d'exportation HOT onglet 4 "Résumé".
image::osm_editieren/osm-daten_beziehen/hotosm_tab4.PNG[]

Enfin, notez les notes sur le post-traitement des géodonnées 
ci-dessus dans ce chapitre.

=== OSMaxx

Avec OSMaxx, des extraits d'OpenStreetMap peuvent être téléchargés 
dans différents formats SIG, pas seulement par pays, mais dans le format souhaité.

Pour utiliser OSMaxx, vous avez besoin d'un compte OSM avec une adresse e-mail valide.

Les extraits existants peuvent être téléchargés sous _Existing Excerpt / Country_. 
Vous pouvez choisir dans quel format le fichier doit être téléchargé, quel système 
de coordonnées doit être utilisé et combien de détails doivent être affichés.

Sous _Nouvel extrait_, vous pouvez sélectionner vos propres zones 
d'OpenStreetMap que vous souhaitez télécharger.
Vous pouvez dessiner un rectangle ou un polygone sur la carte. 
Là encore, vous pouvez choisir dans quel format le fichier doit 
être téléchargé, quel système de coordonnées doit être utilisé et 
combien de détails doivent être affichés.

L'exportation des données prend au moins 45 minutes environ. 

Si vous avez choisi un format SIG et que vous voulez savoir si et où il y a 
des boulangeries, par exemple, allez sur la page "A propos" d'OSMaxx, 
où le schéma de données est documenté.

Enfin, notez les notes sur le post-traitement des géodonnées 
ci-dessus dans ce chapitre.

=== BBBike

BBBike https://extract.bbbike.org/ offre les données de Planet.osm 
dans de nombreux formats de fichiers différents.

Seule une boîte de délimitation doit être créée pour l'extraction. 
La boîte de délimitation peut avoir une taille maximale de 
24'000'000 km², soit 512 mégaoctets comme fichier. 
Après avoir saisi une adresse e-mail valide et attribué un nom à 
l'extraction, vous pouvez cliquer sur le bouton _Extract_. Vous recevrez 
une notification par courriel avec le lien de téléchargement.

Si vous voulez en savoir plus sur BBBike, veuillez consulter 
le lien suivant dans la documentation:

* https://www.bbbike.org/api.html

Enfin, notez les notes sur le post-traitement des géodonnées 
ci-dessus dans ce chapitre.

== Fusion des calques de polygone avec les calques de points dans QGIS

Bei OSM kommt es immer wieder vor, dass ein Objekt - wie beispielsweise eine 
Bäckerei - mal als Punkt (Point) und mal als Gebäudeumriss-Polygon (Area) 
erfasst wird. 
Darum kommt es vor, dass man im GIS Polygon-Layer erhält mit denselben 
Objektarten wie im Punkte-Layer.
Eigentlich will man aber alle Objekte einheitlich und alle auf einmal ansprechen.

Also, gegeben ein Polygon-Layer und ein Punkte-Layer, müssen wir die Polygone im 
Polygon-Layer in Punkt umwandeln und können diese dann im Punkte-Layer 
integrieren. 

Dafür gehst du in QGIS unter Menü "Vektor" zu "Geometrie-Werkzeuge" und dann 
zu "Zentroide...". 
Danach sollte das QGIS so aussehen, wobei dort die Namen der neuen Layer bereits 
umbenannt wurden:

.Polygon-Layer umgewandelt
image::osm_editieren/osm-daten_beziehen/vier_punktelayer.PNG[]

Da wir jetzt mehrere Punkte-Layer haben, müssen wir diese zusammenführen. 
Solch ein Zusammenführen funktioniert nur, wenn alle Layer denselben 
Geometrie-Datentyp haben.
Gehe dafür im QGIS-"Vektor"-Menü zu "Datenmanagement-Werkzeuge" und 
dann zu "Vektorlayer zusammenführen". 
Im Dialogfenster wählst du die vier Layer aus:

.Mehrere Layer zu einem einzigen Layer zusammenführen
image::osm_editieren/osm-daten_beziehen/vektorlayer_zusammenfuehren.PNG["vektorlayer_zusammenfuehren", 480, 317]

Nachdem du das ausgeführt hast, siehst du auf der linken Seite einen neuen Layer.
Die alten Layer brauchst du nun nicht mehr und du kannst sie somit löschen.
Der neue Layer trägt den Namen "Zusammengeführt". 
Es wäre sinnvoll, wenn du ihn zu "Brotverkaufsstellen" umbenennst.
Unten siehst du das Endergebnis dieser zweiten Methode, wobei der Layer (noch) 
nicht umbenannt wurde:

.Endergebnis
image::osm_editieren/osm-daten_beziehen/brotverkaufsstellen_QGIS.PNG[]


== Mit QGIS Objekte filtern oder regelbasiert darstellen

Nachdem du OpenStreetMap-Daten im gewünschten Ausschnitt erhalten hast, möchtest 
du vielleicht nicht mit allen Daten arbeiten. 
Es gibt zwei grundsätzlich unterschiedliche Methoden, eine Teilmenge der Daten 
zu erhalten:
Einerseits kann man die Datenquelle nach selbst definierten Kriterien filtern. 
Und andererseits kann man die Daten regelbasiert darstellen, sodass nur jene 
Daten angezeigt werden, welche die Regeln erfüllen.

Im Folgenden schauen wir uns die beiden Methoden an. 
Das Beispiel mit den Brotverkaufsstellen bleibt gleich. 
Die Brotverkaufsstellen beinhalten sowohl "bakeries" als auch "supermarkets". 
Wir wollen nun aber nur noch "bakeries" in QGIS verarbeiten bzw. darstellen.

=== Mit QGIS Objekte filtern

In QGIS kommt man auf zwei Möglichkeiten zum Dialog, um Objekte zu filtern: 
Entweder man geht im Menü auf "Layer" und wählt dann "Filter..." (während der 
gewünschte Layer ausgewählt ist). 
Oder man macht einen Rechtsklick auf den gewünschten Layer und geht dann auf 
"Filter...". 
Danach öffnet sich ein Dialog mit dem Titel "Abfrageerstellung". 
In diesem Fenster sieht man folgendes:

* Felder: Eine Liste aller Attribute, welche der ausgewählte Layer beinhaltet
* Werte: Die Werte auf dem ausgewählten Attribut die im Layer vorkommen 
(um einige Werte anzuzeigen, klicke auf den Knopf "Stichprobe")
* Operatoren: Logische Operatoren zum Verknüpfen der Felder und Werte
* Datenanbieter-spezifischer Filterausdruck: SQL-Ausdruck zum Filtern der 
Attribute und Werte

Im Eingabefeld "Datenanbieter-spezifischer Filterausdruck" geben wir folgendes 
ein:

[source,sql]
----
"shop"='bakery'
----

"shop" ist das Attribut (beachte die doppelten Anführungszeichen). 
'bakery' ist der Wert (beachte die einfachen Anführungszeichen).

Das Fenster sollte dann folgendermassen ausschauen:

.Objekte filtern
image::osm_editieren/osm-daten_beziehen/filtern.PNG["Objekte filtern", 490, 407]

Nun klickst du auf "OK". 
Du solltest nun die Meldung bekommen, dass ca. 10 Objekte gefunden wurden, 
die beim Attribut "shop" den Wert "bakery" haben.
Wir sehen nur noch diejenigen Objekte, die das Filterkriterium erfüllen. 
Alle anderen Objekte sind nicht mehr Teil der Datenquelle des Layers:

.Bäckereien in Uster
image::osm_editieren/osm-daten_beziehen/uster_bäckereien.PNG[]

Wie du oben siehst, solltest du nun den Layer entsprechend von 
"Brotverkaufsstellen" in "Bäckereien" umbenennen.

=== Mit QGIS Objekte regelbasiert darstellen

Bei der regelbasierten Darstellung geht es darum, aus einer Layer-Datenquelle 
heraus alle diejenigen Objekte darzustellen, die ein Kriterium erfüllen. 
Man spricht auch von "Daten-getriebender Darstellung".
Dieser Ausdruck, nach dem es zu filtern gilt, ist hier Teil der Darstellung 
(Symbologie) und nicht Teil des Layers wie bei der anderen Methode. 

Die regelbasierte Darstellung kann man auch dazu verwenden, einzelne Werte 
_nicht_ darzustellen. 
In unserem Beispiel wollen wir das ausnutzen, um nur Bäckereien ('bakery') und 
keine Supermarkets ('supermarket') darzustellen. 
Dazu machen wir einen Rechtsklick auf den Layer und klicken den untersten 
Eintrag "Properties..." an. 
Im linken Listenmenü klicken wir dann auf "Darstellung" (dritter Eintrag). 
Nun sollte es bei dir so aussehen:

.Darstellung von Objekten
image::osm_editieren/osm-daten_beziehen/single_symbol.PNG["single_symbol_menu", 590, 357]

Im oberen Bild siehst du eine rote Markierung um den Eintrag "Single symbol". 
Dies deshalb, da wir jetzt diesen Eintrag zu "Rule-based" ändern.
Bisher war es so, dass alle Objekte gleich behandelt (nicht unterschieden) und 
somit gleich dargestellt wurden, deshalb "Single symbol". 
Jetzt, da wir "Rule-based" selektiert haben, können wir Regeln (Ausdrücke) 
definieren, um die Objekte je nach Attributwert verschiedenen Symbolen zuzuordnen.

.Objekte ohne Filter
image::osm_editieren/osm-daten_beziehen/kein_Filter.PNG["Objekte ohne Filter", 630, 381]

Im oberen Bild siehst du, dass wir einen Eintrag haben. 
Dieser Eintrag beinhaltet alle 27 Objekte, und wir sehen, dass keine Regeln auf 
diesen Objekten definiert sind. 
Deshalb klicken wir zwei Mal auf den Eintrag. 
In das Textfeld neben "Filter" geben wir nun wieder folgendes ein:

    "shop"='bakery'

Das sieht dann so aus:

.Edit Rule Dialog
image::osm_editieren/osm-daten_beziehen/edit_rule.PNG["Edit-Rule-Dialog", 319, 260]

Nun klicken wir auf "OK". 
Wir sehen, dass im Eintrag nun nicht mehr "(kein Filter)" steht, sondern 
`"shop"='bakery'`. 
Jetzt klicken wir auf "Anwenden" und dann nochmals auf "OK". 
Im QGIS sollte das nun so aussehen:

.Bäckereien in Uster
image::osm_editieren/osm-daten_beziehen/uster_bäckereien_nach_regeln.PNG[]

Wir sehen, dass wir nach wie vor 27 Objekte haben. 
Angezeigt werden uns aber nur die 10 Objekte, die die Regel erfüllen, also nur 
Bäckereien. 
Vielleicht hast du es schon bemerkt, denn im Gegensatz dazu verändert sich die 
Anzahl Objekte beim einfachen filtern (siehe oben). 
Dort werden nicht nur die 10 Bäckereien dargestellt, sondern die Objektanzahl 
verringert sich auch auf 10. 
Dies ist ein besonderer Unterschied zwischen dem "normalen" Filtern und der 
regelbasierten Darstellung. 
Sehen wir uns noch eine andere Möglichkeit an.

Angenommen, wir möchten nach wie vor alle Objekte anzeigen und nur einen Teil 
abrenzen, dann können wir einfach eine andere Farbe für alle Bäckereien nehmen.
Lösche die Regel, die wir vorhin auf die Objekte angewendet haben, wieder. 
Dann starten wir ab folgender Ansicht:

.Objekte ohne Filter
image::osm_editieren/osm-daten_beziehen/kein_Filter.PNG["Objekte ohne Filter", 630, 381]

Unten links klicken wir auf das Plus-Zeichen. 
Jetzt haben wir unsere Objekte kopiert und wenden auf diese Kopie die Regel an. 
Also auch wieder folgendes eingeben und dann auf "OK" klicken:

.Edit Rule Dialog
image::osm_editieren/osm-daten_beziehen/edit_rule.PNG["Edit-Rule-Dialog", 319, 260]

Nun klicken wir auf "Anwenden" und dann auf "OK". 
Jetzt sollte es im QGIS so aussehen:

.Brotverkaufsstellen mit farblich abgegrenzten Bäckereien (Pink)
image::osm_editieren/osm-daten_beziehen/brotverkaufsstellen_regelbasiert.PNG[]

Der Layer "Brotverkaufsstellen" sollte nun zwei verschiedene Objektgruppen 
aufweisen. 
Einerseits sehen wir alle 27 Brotverkaufstellen in oranger Farbe.
Andererseits haben wir nun eine neue (Unter-)Gruppe mit 10 Objekten, 
nämlich unsere Bäckereien in pinker Farbe.

Damit schliessen wir dieses Kapitel bzw. dieses Arbeitsblatt ab und überlassen 
es dir, die Layer und das ganze QGIS-Projekt zu erweitern und die Darstellung 
zu verbessern.


include::../../snippets/quellenangabe.adoc[]
