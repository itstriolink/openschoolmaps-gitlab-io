= Practice/Exercise: Room analysis raster data - Where the chamois live
OpenSchoolMaps.ch -- Freie Lernmaterialien zu freien Geodaten und Karten
:xrefstyle: short
:imagesdir: ../../../bilder/rasterdaten-analyse_gaemsen
:experimental:
include::../../../snippets/lang/de.adoc[]
include::../../../snippets/suppress_title_page.adoc[]

A multi-criteria raster analysis with QGIS 3

.Bild CC BY-SA 4.0 Paul Hermans. (Quelle: https://commons.wikimedia.org/wiki/File:Gemse01.JPG)
[caption=""]
image::000_titelbild.png[]

== General information
Do you know where the chamois potentially live?
A multi-criteria raster analysis with a GIS provides the answer.
This exercise was originally written by Andreas Lienhard,
Canton Zurich (many thanks!),
and was then further developed.

* Expenditure of time:
  This exercise takes at least 30 minutes
  if you already know something about QGIS.
* Requirements:
  QGIS 3 (this exercise was created
  with QGIS version 3.6 and tested
  with QGIS 3.4 LTS).
* Tags:
  GIS, Raster, Grid, Multi-criteria analysis, Raster algebra, QGIS.

== Goals and specifications
The goal of this exercise is to use multi-criteria
GIS analysis to find out where chamois
potentially have their habitat.
We make the following assumptions (criteria) for this purpose:

1. Chamois stay above 1500 m above sea level.
   We are also looking for chamois in spring, 
   i.e. there is still a lot of snow starting at 2500 m.
2. Chamois are mainly found on steep slopes (slope >20%).
3. Chamois prefer warm, early leveled slopes, i.e. southern slopes.
4. Chamois use alpine pastures, because in spring there are no cattle on the alp.

The following two grid/grid data sets are available for
the analysis (further information on the ASCII grid format
can be found here http://giswiki.hsr.ch/Grid ):

* Elevation model "`DHM-Rimini`" 
  (originally from Swisstopo) in
  ArcInfo ASCII grid format, file
  `dhm_rimini.txt`.
  (Elevation model: Digital Height Model, DHM)
* Statistical data "`area statistics 85`"
  (originally from BfS) in ArcInfo ASCII
  grid format, file `as85.txt`.
  Contains soil cover species such as wad, meadows and pastures.

== Preparations
After the specifications have been clarified, 
we can begin with the analysis of the potential chamois habitats.
This is the schedule:

* First the elevation model and the area statistics are loaded into QGIS.
* With the elevation model, a terrain shading 
  map is created in advance as a pure background.
* With the elevation model, an inclination map and a terrain 
  alignment map are calculated and saved as intermediate results.
* Then partial results are calculated and saved
  according to the four criteria:
** Starting from the elevation model, the corresponding
   elevation areas are filtered.
** The steep slopes are filtered on the basis of the slope map.
** Starting from the orientation map, the southern slopes are filtered.
** Based on the area statistics, the alpine pastures are filtered.
* Finally, the last four intermediate results are intersected
  (spatial overlay, intersection) and the result is visualized.

Now start QGIS - or open a new QGIS project -
and change the project's coordinate reference
system to the old Swiss coordinate
reference system EPSG:21781.

== Import
To load the two input files `as85.txt` and `dhm_rimini.txt`
you can either drag and drop them into the QGIS or open the 
menu menu:menu:Layer[Add Layer].
There select menu:Add Rasterlayer...[]
and specify the appropriate files.
Select as coordinate reference system EPSG:21781.

Check that the layer "`dhm_rimini`" is
visible at the top of the layer manager, 
otherwise simply pull up the layer in the layer manager.
If the layer is black, you can customize it by going
to Layer Properties and changing "Contrast Enhancement"
from "Cut to MinMax" to "Stretch to MinMax"
(there are some more display options).
Now you should see what is shown below.

image::00_geladen.png[]

== Terrain shading map
This step is not yet part of the evaluation but rather
serves for visualization and orientation on the map.
The menu menu:Raster[] allows you to edit
and change the raster layers in QGIS.
New layers are usually created and displayed in the QGIS project.

image::01_menu.png[]

To create a terrain shading map from an elevation model,
select menu menu:Raster[Analysis > Shading] (see figure below).

image:01_schummerungskarte.png[pdfwidth=48%] image:01_schummerung_protokoll.png[pdfwidth=48%]

As input file you choose the layer "`dhm_rimini`".
Click on "shading" (output file) right on btn:[...],
you open a new exercise data folder e.g. `chamois`
and enter the name `terrain.tif`
(the extension tif stands for TIFF or GeoTIFF).

After a click on btn:[Start] the dialog window automatically
changes to the tab with the execution protocol.
You can then close the "Shading" window with the protocol.
After that you should get about the following result with the terrain shading:

image::01_schummerungskarte_bsp.png[]

At this point also save the whole QGIS project in
the folder `chamois` with the name `chamois.qgz`.

image::02_perspective.png[]

Now we come in the next chapter to the first
evaluation with the partial result "terrain alignment".

== Terrain orientation map
The terrain orientation map shows the aspect 
of the terrain in relation to the north.
It is created with an elevation model as source
via menu:Raster[Analysis > Perspective]
(menu:Raster[Analysis > Aspect...]) (see figure above).

As input layer you choose "`dhm_rimini`" again.
Vote "Perspective". (output file), the exercise
data folder (`gaemse`) and the file name
`aspect.tif`: see figure above.

If everything went right, you should see something like this (may vary):

image::02_perspective_bsp.png[]

But now we want to improve this representation 
of the terrain alignment map a little bit.
To change the style of a layer, right-click or
double-click on the layer name and its properties.

In the "`Symbolisation`" in the first entry 
"`Channel display`", select the display type 
"`Singleband pseudocolor`".
Only the "`Channel 1 (grey)`" can be selected as the channel.
Now you can set "`Min`" to 0 and "`Max`" and to 360, 
"`Interpolation`" to "`Linear`", as "gradient" choose
any one so that the automatic classification works 
(which gradient doesn't matter as we will assign 
the colors manually), set the mode to "Equal Interval"
and the number of classes to 5.

An orientation map contains as value an angle (in degrees °),
which represents the orientation of the terrain.
We want to assign different colors to the
four main directions (N, O, S, W).
The result of the operation used corresponds to 0° north (N).
Values close to 0° therefore indicate a north slope.
But also values close to 360° represent northern slopes.
Therefore, five instead of only four classes were used.
Therefore assign the same color to the first and last class, e.g. blue.
The angle in the result is to be understood clockwise, i.e. 90° is East.
Assign different, easily distinguishable colors
to the remaining three classes,
e.g. red, yellow, green.

If you want, you can give the classes a meaningful
"label", e.g. N, O, S, W (and again N).

image::02_perspective_colors.png[]

When you have made all the settings, 
go to the `Transparency` tab. (below tab "`Symbolisation`").
Here we set the global transparency to e.g. 50%
so that you can still see the shading
under the coloured alignment map.

image::02_perspective_transparenz.png[]

Then click on btn:[Ok] (the dialog closes).

The result should look like the one shown below.
If you've set other colors, it's no big deal.
The main thing is that the points of the compass
are now visualized by different colors.

image::02_perspective_final.png[]

== Neigungskarte
With the function `slope`" (menu menu:menu:Raster[Analysis > Slope])
you can display the slope of a terrain coded as raster/grid.
For this exercise we want to express the gradient
in percent instead of degrees (see below).
As input file, select the layer "`dhm_rimini`"again
and enter the output file `slope.tif` in the exercise data folder.
Then btn:[Start].

image::03_slope_inked.png[]

The result looks like this 
(for "Contrast enhancement" on "Stretches on MinMax"):

image::03_slope_bsp.png[]

== Filter by criteria
Du hast nun die Daten so weit vorbereitet,
dass wir die Kriterien anwenden können.
Zur Erinnerung:
Wir suchen diejenigen Gebiete, die folgende Kriterien erfüllen:

1. Gebiete, die höher als 1500 m. ü. M und tiefer als 2500 m. ü. M. liegen.
2. Gebiete, die steiler als 20% sind.
3. Südhang-Gebiete,
   d.h. Gebiete, die eine Ausrichtung von Südost bis Südwest haben.
4. Gebiete, welche die Nutzung
   Wies- und Ackerland, Heimweiden, Maiensässe, Heualpen, Bergwiesen, Alpweiden
   aufweisen.

Um diese Anforderungen zu erfüllen,
errechnen wir nun vier weitere Layer aus den vorbereiteten Daten.
Ein Verschnitt daraus wird uns aufzeigen, wo sich Gämse aufhalten könnten.
Der Verschnitt und die Filterung erfolgt
mit der "`Rasteralgebra`" und in QGIS mit dem Rasterrechner.

Beginnen wir mit dem ersten Kriterium:
Die Höhen des Geländes sind im Layer "`dhm_rimini`" gespeichert.
Damit werden wir nun einen neuen Layer berechnen,
der nur noch diejenigen Rasterzellen beinhaltet,
die zwischen 1500 und 2500 m. ü. M. liegen.
Dafür müssen Sie nun den Rasterrechner über das Menü menu:Raster[] öffnen.

image::04_rasterrechner_menu.png[]

Im Rasterrechner musst du wieder rechts oben den Ausgabelayer angeben.
Wähle den Übungsdaten-Ordner
und nenne die Ausgabedatei `dhm_rimini_1500_2500.tif`.

image::05_dhm_rastercalc.png[]

Links im Dialog sind die verfügbaren Layer
mit ihren "`Rasterkanälen`" (hier immer "`@1`") aufgelistet.
Für diese erste Berechnung wählen wir "`dhm_rimini@1`".
Per Doppelklick darauf
kann dieser in Anführungszeichen dem Rasterrechnerausdruck hinzugefügt werden.
Der Ausdruck ist aber noch nicht bereit.
Wir möchten noch nach Werten zwischen 1500 und 2500 filtern.
Dazu wählen wir die Operatoren "`grösser-gleich`"/"`kleiner-gleich`"
(`>=` und `\<=`), die wir mit `AND` verknüpfen und einklammern.
Damit bekommen diejenigen Werte, die dazwischen liegen eine 1.
Doch von diesen möchten wir eigentlich den Originalwert behalten.
Dazu multiplizieren wir den eingeklammerten Ausdruck
mit dem ursprünglichen Wert selbst
(das ist raffiniert ☺, denn der geklammerte boolesche Ausdruck
wird offenbar als Zahl 1/0 interpretiert anstelle von wahr/falsch).
Man kann den Ausdruck entweder direkt eintippen oder
mit Klick auf die Operator-Buttons im Bereich "`Operatoren`" zusammenstellen.
Mit btn:[OK] den Rasterrechner starten.

image::05_dhm_rastercalc_bsp.png[]

Wir können nun überprüfen,
ob alle gewünschten Punkte ihren Wert beibehalten haben,
indem wir durch Klicken auf "`Objekte abfragen`" (das "`i`"-Icon)
und mit der Maus ins Fenster klicken:
Bei schwarzen Rasterzellenn (Pixel) wird der Wert 0 angezeigt
und bei grauen ein Wert zwischen 1500 m. ü. M. und 2500 m. ü. M..

Um die 0-Werte auch aus der Ansicht herauszufiltern,
können wir ihnen noch eine Transparenz zuordnen.
In den Layer-Eigenschaften > "`Transparenz`"
und "`Benutzerdefinierte Transparenzeinstellung`" klickst du dazu auf btn:[+]
und setzt die beiden Werte "`Von`" und "`Nach`" auf 0
sowie "`Prozent Transparenz`" auf 100 Prozent.
Danach klickst du auf btn:[Anwenden].

image::05_dhm_rastercalc_bsp_transparenz.png[]

Schalte nun im Layer-Manager die Sichtbarkeit des Layers "`Neigung`" aus. +
Das Ergebnis ist nun so gefiltert, dass man die anderen Layer darunter sieht:

image::05_dhm_rastercalc_bsp_transparenz_bsp.png[]

Die gleichen Schritte
- zuerst Rasterrechner dann Transparenz –
wendest du nun für alle weiteren drei Kriterien an, wie folgt:

Für das zweite Kriterium gehst du vom Layer bzw. Kanal "`Neigung@01`" aus
und speicherst das Resultat im Übungsdaten-Ordner
unter dem Namen `slope_over20perc.tif`
(btn:[Ok] ist noch nicht aktiviert).
Selektiere mit dem Rasterrechner in diesem Falle alle Rasterzellen,
die steiler als 20% sind.
Dann btn:[Ok].

Für das dritte Kriterium verwendest du den Layer "`Perspektive`" (`aspect.tif`)
und filterst alle Rasterzellen heraus,
welche zwischen den 135 und 225 Grad liegen (d.h. 180 Grad plus/minus 45 Grad).
Damit erhältst du alle nach Süden gerichteten Hänge
(zur Erinnerung Norden ist 0°).
Speichere das Resultat im Übungsdaten-Ordner
unter dem Namen `aspect_135_225.tif`.
Dann btn:[Ok].

Für das vierte und letzte Kriterium nehmen wir den Layer "`as85`".
In diesem sind die verschiedenen Geländearten als Code (Ganzzahl) abgespeichert.
Uns interessieren nur alle jene Gebiete,
welche die folgenden Nutzungen aufweisen:
Wies- und Ackerland, Heimweiden, Maiensässe,
Heualpen, Bergwiesen, Alp- und Juraweiden.
Diese entsprechen den Codes 8, 9, 10 und 11.
Filtere den Layer "`as85`" daher nach diesen Codes.
Speichere das Resultat
im Übungsdaten-Ordner unter dem Dateinamen `as85_sorted.tif`.

Denke daran, für jeden Layer die benutzerdefinierte Transparenz
auf 100 Prozent für die Werte von 0 bis 0 zu setzen (vgl. Layer-Eigenschaften).

Probiere dies für alle Schritte aus.
Solltest du nicht weiterkommen,
so ist im nächsten Kapitel
jeder Schritt noch mit Lösung und Screenshots beschrieben.

Nun hast du alle nötigen Vorberechnungen gemacht.
Nun musst du noch die vier Layer verschneiden (engl. overlay/intersection).
Dazu verwendest du wieder den Rasterrechner und kombinieren die vier Layer
"`dhm_rimini_1500_2500`", "`slope_over20perc`", "`aspect_135_225`" und "`as85_sorted`"
mit dem logischen UND-Operator.
Nenne das Resultat `gut_fuer_gaemsi.tif`
und speichere es wieder in den Übungsdaten-Ordner.
Auch hier solltest du die benutzerdefinierte Transparenz
auf 100 Prozent für die Werte von 0 bis 0 setzen.

Wenn du willst, kannst du auch dieses Ergebnis
mit einer Einkanalpseudofarbe oder Palette einfärben:

image::09_gut_fuer_gaemsi_bsp.png[]

Nun wissen wir wo die Gämsen mutmasslich "`wohnen`"!
Dies zumindest gemäss unseren Daten und Annahmen.

Für diese Übung sind nun soweit zufrieden.
Es gäbe aber noch einige Verbesserungsmöglichkeiten,
einerseits für die bessere Lesbarkeit
(z.B. mit wichtigen Orten, Strassen und Berggipfel)
und andererseits mit verbesserten Analysen
wo man beispielsweise die Rasterzellen in Vektoren umwandeln könnte,
um die resultierenden Polygone dann mit weiteren Daten verknüpfen zu können.

<<<

== Detailed instructions
This chapter is a supplement to the previous chapter,
where only the first criterion was explained in detail.

To calculate the other three criteria, 
we proceed in the same way as for the first criterion.
I.e. we first use the raster calculator and then 
set the transparency of the unneeded values to "transparent".

=== Second criterion (areas steeper than 20%):
Open the raster calculator, select the raster channel "`Neigung@1`"
and enter the following raster expression:
----
("Neigung@1" > 20) * "Neigung@1"
----

image::06_slope_20percent.png[]

Then set the transparency of the layer.

The result of the second criterion should be approximately as follows:

image::06_slope_20percent_bsp.png[]

=== Third criterion (southern slope):
In the raster calculator set the output layer `aspect_135_225.tif`,
select the raster channel "Perspektive@1" and
enter the following raster calculator expression:
----
("Perspektive@1" >= 135 AND "Perspektive@1" <= 225) * "Perspektive@1"
----

image::07_aspect_south.png[]

Then set the layer transparency.
The result of the third criterion 
(single channel pseudocolors copied from "perspective")
should look something like this:

image::07_aspect_south_bsp.png[]

=== Fourth criterion (types of terrain):
In the raster calculator select the raster channel
"`as85@1`", the output layer `as85_sorted.tif`
and enter the following raster expression:
----
("as85@1" >= 8 AND "as85@1" <= 11) * "as85@1"
----

image::08_as_sorted.png[]

Below is the result of the fourth criterion 
(palette colors and also with transparency):

image::08_as_sorted_bsp.png[]

=== Spatial overlay:
Last but not least we calculate the chamois locations with a spatial overlay
(intersection) and save it under `good_for_chamois.tif`.
Here is the solution for the raster computer printout:
[source,sql]
----
"dhm_rimini_1500_2500@1" AND "slope_over20perc@1" AND "aspect_135_225@1" AND "as85_sorted@1"
----

image::09_gut_fuer_gaemsi.png[]

The resulting result is shown at the end of the previous chapter.

■