= Practice/Exercise: Spatial Analysis Vector Data - Motorway
OpenSchoolMaps.ch -- Freie Lernmaterialien zu freien Geodaten und Karten
:xrefstyle: short
:imagesdir: ../../../bilder/vektordaten-analyse_autobahn
:experimental:
include::../../../snippets/lang/de.adoc[]
include::../../../snippets/suppress_title_page.adoc[]

Impact assessment of a motorway construction with QGIS 3

.Kartendarstellung des Analyse-Ergebnisses. Siehe auch <<endergebnis-image>>
image::11_endergebnis_ausschnitt.png[pdfwidth=100%]


== General information

The assessment of impairments of legally protected biotope types 
by traffic structures is a typical task of landscape planning.
The task is based on the construction of the A44 through 
the German Lichtenau plateau without using the original data.

.Contents

* Effects of a motorway section on habitat types
* Access to geodata processing
* Working with buffers and intersections

.Reference
This task is mainly based on http://www.gkg-kassel.de/pdf/aufgabe_6.pdf[Task 6] 
of the course "`Introduction into GIS and digital cartography`" 
by http://www.gkg-kassel.de[Claas Leiner], Uni Kassel, 2010.


== Goals and specifications

The goal of this exercise is to assess the impact of motorway construction
on habitat types Fauna-Flora-Habitat (FFH for short, a European legislative directive,
see https://de.wikipedia.org/wiki/Richtlinie_92/43/EWG_(Fauna-Flora-Habitat-Directive)[Wikipedia])
and legally protected biotope types.

The working data are polygon vector data (layer "`environment`" in geopackage
`autobahn_inputs.gpkg`) with the results of a biotope type and usage mapping,
lines vector data (layer "`autobahn_central line`" in geopackage
`autobahn_inputs`).gpkg`) with the central line of a fictitious motorway
route and the topographic map 1:25'000 (Tk25) (file `heli.tif`) as background.

In the functional data table of "environment", 
pieces of usage (impacts) that are to be assigned 
to a habitat type (ffh_typ_nr) are marked (ffh_typ_text).
Likewise, specially protected biotope types according to
federal law (abbreviated to BNatSchG) (field "`geschuetzt_biotop`")
and other types of species-rich grassland ("`bedeutend_gruenland_typ`")
are labelled.

You should determine the size of the valuable area from the point of view
of species and biotope conservation that is completely
destroyed or impaired by motorway construction.
To answer this question, you can use the "`buffer tool`"
to identify degradation zones at different distances
from the central line, which are further intersected 
with biotope type mapping to identify degraded and unimpaired areas.

Finally, the results could be entered in a table 
as an area balance (optional).


.Aids

* QGIS (tested with QGIS 3.4)
* Data:
** `autobahn_inputs.gpkg`
** `heli.tif`

<<<


== Tasks

=== Preparation: Creating the project file and loading the input data

1. Open QGIS and make sure that no existing project is open.
   (So only either a new, still empty and unsaved project or none at all.)
2. Load `autobahn_inputs.gpkg` with both vector layers included.
3. If no project was open yet, a (not yet saved)
   one has been created automatically.
   Make sure that in the project settings the coordinate reference
   system (CRS) is set to the German DHDN Gauss-Krüger Zone 3 (EPSG:31467).
   (This should be the case automatically after loading the layers.)
4. Open the project settings via the menu "Project > Properties...",
   give the project the title "Motorway and habitat types" under the
   tab "`General`" and save it under the name `Autobahn_Lebensraumtypen.qgz`
   or `Autobahn_Lebensraumtypen.qgs`.


=== Task 1: Presentation of land use

1. Classify layers "environment" using the attribute
   bfn_biotop_text to get an overview of the biotope types.
   A coarser representation of land use can be achieved by
   classifying land use according to the "use" field.
   Work out a meaningful representation using colors
   and textures. Present your classification as a map.
2. Create a map layout and export it as `biotoptypen.pdf`.
   If you are using textures, you should check the "Print
   as raster" box on the "`General > Print quality`" tab
   in the print composition before exporting.


=== Task 2: Displaying the motorway central line and creating the buffer zones

Let's now turn to the motorway central line in Layer autobahn_zentrallinie.

[start=5]
5. Make the line clearly visible.

6. The motorway body measures 40m in total.
For a two-dimensional representation you have to create
a buffer polygon with a distance of 20 m from the center line on both sides.
+
You can do this via the menu "Vector > Geoprocessing Tools > Buffer".
The "Input layer" is the "Motorway central line", the "distance" is 20 meters.

7. We want to record the result of this process in a file.
To save it as a layer in a new file, click the btn:[...]
button next to the layer name field and choose
menu:Save{sp}as{sp}Geopackage...[].
Name the new file `autobahn_analyse.gpkg` and the new layer route_20.

8. Execute the processing with the button btn:[Start].
+
Now you see the highway body in your study area.

9. Even if the layer in the new file is now called
`trasse_20.gpkg`, it may have been labeled "buffered" in QGIS.
Rename it to "`route_20`" if necessary.
This is possible via the layer properties, which you can
access e.g. via the context menu of the layer entry in the layer panel.

10. The impairments of the motorway extend beyond the motorway route.
Therefore you have to create more buffer zones.
+
--
Create two more "buffers" starting from the route you just created:

** One with a distance of 100 m as *temporary layer* route_20_buffer_100
** A 300 m apart *temporary layer* route_20_buffer_300.
--
+
route_20_buffer_100 identifies the areas immediately
adjacent to the motorway in which major impairments
due to exhaust fumes, noise and waste
water are to be expected.
The area of route_20_buffer_300 includes the further intervention
area up to a distance of 300 m from the motorway.

11. Also here it is possible that the temporary files created in
the background for the layers are called as required,
but the layers are listed as "buffered" in QGIS.
Rename them accordingly.

.QGIS-Dialog zu Puffer.
image::02_qgis-puffer-dialog.png[]


=== Task 3: Create Ring Zones Excluding the Buffer Zones

All buffer polygons created cover the entire area between your outer borders.
The large buffer areas cover the small zones.
However, we need polygons in the form of adjoining zones that do not overlap.
In order to achieve this goal, we use the tool
"`difference`" for testing purposes.
After the following intersection processes you have the
body of the motorway as well as two enclosing and
adjoining shells around the motorway.

Creation of the external zone (from 100 m to 
300 m distance from the motorway):

[start=12]
12. The area of the buffer route_20_buffer_100 must
be cut out of the buffer route_20_buffer_300 in order
to demarcate the external impairment zone.
+
This can be achieved with the menu option
"Vector > Geoprocessing Tools > Difference".

** "`Input layer`" = route_20_buffer_300
** "`Layer overlay`" = route_20_buffer_100

13. Save the result in the existing file
`autobahn_analyse.gpkg` as a new layer zone_100_300.

14. Also here it is possible that QGIS saves the layer
under the correct name, but integrates it into
the project itself as "difference".
Rename it to zone_100_300 if necessary.

.Dialog "`Symmetrische Differenz`".
image::03_qgis-differenz-dialog.png[]

Creation of the internal zone (from the route to 100 m from the motorway).

[start=15]
15. The area of the buffer route_20 must be cut out of the buffer
route_20_buffer_100 in order to delimit the inner impairment zone.
Save it as Layer zone_100 also in `analyse.gpkg`
and rename the layer to QGIS if necessary.
** "`Input layer`" = route_20_buffer_100
** "`Layer overlay`" = route_20

The following layers are now important:

* The two layers with the input data
* The actual 40 metre wide route: route_20
* The zone from the route to a distance of 100 m: zone_100
* The zone at a distance of 100 m up to 300 m from the route: zone_100_300

If everything went fine, you can hide or delete
the two temporary layers for a better overview:

* route_20_buffer_100
* route_20_buffer_300


=== Task 4: Merge the three zones into one layer

With the Merge tool,
any number of geometries can be
merged into one layer in one step.

1. Select menu:Merge{sp}vector{sp}layer...[]
from the menu "Vector > Data management tools"

2. Choose as the input layer:
** route_20
** zone_100
** zone_100_300

3. Save the result in `autobahn_analyse.gpkg` as layer "`zones`".

4. Also here it can be that QGIS integrates the new
layer under a generic name (here: "merged").
Rename it to `zones` if necessary.


=== Task 5: Edit the attribute table of the vector file `all_zones.shp`.

The new layer does not yet have meaningful attribute
values for the individual impairment zones.
You must assign an attribute value to the zones so that
you can determine the area of differently rated biotope
types in the impairment zones.
Edit the attribute table in the layer properties

1. Open the context menu of the layer "zones" and choose menu:Properties...[].
2. In the layer properties window, select the "source fields" tab.
3. Activate the editing mode (button with the pen)
4. Delete all fields except "`layer`" and "`fid`".
5. Rename the field "`layer`" to "`zone`".
6. Close the Layer Properties window with btn:[OK].
7. Open the context menu of the layer "zones" and
   choose menu:Open{sp}attribute{sp}table[].
8. Change the values in the `zone` column as follows:
** route_20 -> Route
** zone_100 -> Inside
** zone_100_300 -> Outside
9. You can then cut off the excess end curves of the buffers
   with the drawing tool "Edit > Split objects" (the cutting line
   can be completed with a right click), select these remaining
   areas via "Edit > Selection > ..." and then delete the remaining
   areas with the function "Edit > Selected delete".
10. Save the layer (menu "Layer > Switch editing status")
    and classify the zones.
    Use hatching or point density grids to avoid 
    completely covering the underlying planes.


=== Task 6: Query of all areas of outstanding nature conservation expertise

Now all areas from the environment layer that are important
for nature conservation are to be queried.
These are habitat types in annex 1 of the Habitats Directive
(ffh_typ_nr), specially protected biotope types in accordance
with the Federal Nature Conservation Act (BNatSchG)
(protected_biotope) and other biotope types of species-rich
grassland (significant_green_land_type).

Proceed as follows:

1. Select the layer "`environment`" in the layer panel.

2. Open the attribute table ("Layer > Open Attribute Table")
to get an overview.
(After that you can close the attribute table again.)

3. Open the query editor via the menu option "Layer > Filter...".

4. Create a query using the query editor buttons to select
all areas that are either FFH habitats (`ffh_typ_nr = 1`),
protected biotopes (`OR protected_biotop = 1`), or other significant
grassland types (`OR significant_greenland_typ = 1`).
+
Note:
In the relevant columns of the attribute table,
the value `1` means "`applies` to`".
+
Your SQL command must look like this:
+
[source,sql]
----
ffh_typ_nr = 1 OR geschuetzt_biotop = 1 OR bedeutend_gruenland_typ = 1
----

5. Test the query.
+
The selection should contain 43 polygons.

6. Confirm with btn:[OK].
This applies the filter to the layer
and closes the query creation window.
Now you can see all areas that are valuable from
the point of view of biotope and species conservation.

7. Save the filtered layer(s) via "Layer > Save as..." in 
the geopackage `autobahn_analyse.gpkg` as layer "`valuable`".
After that you can delete the filter on layer "`environment`" again.

.Dialog.
image::06_qgis-abfrage-ergebnis.png[]


=== Task 7: Intersection between valuable areas and impairment zones

The next step is to identify those areas of nature conservation
value that are located in the three impaired zones.
You're using the `intersection` tool to intersect
the layers valuable and zones with each other.
The resulting layer contains only areas which are valuable for
nature conservation and which are destroyed or impaired at
the same time by motorway construction.

1. With the menu option "Vector > Geoprocessing
Tools > Intersection..." you intersect both layers.
** "Input Layer": zones
** "`Layer overlay`: valuable
** Target layer: *Untitled Temporary Layer*

2. A click on btn:[Start] leads to the following error message:
+
____
Object (24) has invalid geometry.
Please correct these errors or change the processing
setting to "Ignore invalid input objects".

Execution failed after 0.01 seconds
____
Open the QGIS options via menu "Settings > Options..."
and change under tab "`Processing`" > section "`General`"
the corresponding setting "`Suspend invalid object filtering`"
from "`Stop algorithm execution on invalid geometry`" to
"`Ignore invalid geometry objects.`".

3. Now repeat the blending operation.
Now it should succeed.
The error message comes anyway, but with
"`finished`" instead of "failed`".

4. The resulting layer has probably been
included in QGIS under the name "`intersection`".
Rename it `intersect_valueful`.

5. Open the attribute table of the new layer.
The values of the "`fid`"-column of the 2nd input layer
("`valueful`") can be found in the column "`fid_2`" of the new layer.
The "`fid`"-column of the 1st input layer (zones) is shown
in the result as "`fid`" in "`intersect_valueful`" but as
"`fid`", which is problematic, because QGIS takes this 
column name as PK of e.g. GeoPackage layers by default, 
but the values are now anything but UNIQUE due to the intersection.

6. Rename the "`fid`"-column from
"`intersect_valueful`" to "`fid_zone`" and end the editing mode.

7. Via its context menu you can now make layer "`intersect_valueful`" permanent.
Save it as "`intersect_valueful`" in `autobahn_analyse.gpkg`.
Make sure that the name specified in the 
"FID" field does not correspond to an existing column.

8. Now you can add "`intersect_valueful`" to
the attribute table of the layer. (Menu "Layer
> Open Attribute Table") click on the "`Field Calculator`"
in the upper right corner.
This allows you to create a new field based on an "expression".
Use the following expression to use QGIS to calculate the area
of our polygon, which is then divided by 100 to convert
the square meters to ares.
The result is ultimately rounded to 1 significant digit after the decimal point.
Expression: round($area / 100, 1)

9. Set "`area`" as "`output field names`" and select
the "`output field types`" "`decimal number (real)`".
Confirm with btn:[OK] and check if a column
with the name "`area`" has been created.

10. Now in the column "`area`" you can find the
exact areas of the polygons in ares.

11. Save the new column by deactivating the edit
mode for the intersect_value layer.


=== Task 8: Classify vector files and create maps

Afterwards you should present your newly created
geometries as meaningful maps.
You should present the valuable biotope
types in the impairment zones or the conflict zones as a map.

1. Classify Layer intersect_valueful by attribute ffh_typ_text (click on btn:[Classify]).
2. Delete the empty value.
3. The layer now displays all areas within the affected 
   zones where FFH-relevant biotope types are located.
4. Filter Layer intersect_valueful with the help of 
   the query editor with the query ffh_typ_nr = 0.
5. Save the selection via "Layer > Save as..."
   under the layer name "`intersect_valueful_without_ffh`"
   in `autobahn_analyse.gpkg`.
6. Load the new layer and classify it by bfn_biotop_text
7. Delete the empty value and you get three classes of valuable non-FFFH biotopes.
8. Load the enclosed raster file `heli.tif` and move it to the bottom of the table
   of contents. Then adjust the global transparency in the layer properties of
   `heli.tif` so that the raster layer can serve as a weakly visible background.
9. Now you can create a map which shows the valuable biotope types affected by
   the motorway construction and additionally highlights the ffh_typ_nr.
10. Create a map layout and export it as PDF. 
    (Activate before under General: "`Print as Raster`")
11. You can see an example of a possible map display on the following page.
    But you don't have to create a layout with two cards.
    It is enough if you decide on a content statement and visualize
    it in a meaningful map layout.


=== Closure

The following files must now be present:

* The simple biotope type map.
* A finished map layout in PDF format, which represents either
  the valuable biotope types in the area of impairment or the
  conflict zones from the point of view of biotope and species protection.

[[endergebnis-image]]
.Darstellung des des Analyse-Ergebnisses in einem Beispiel-Layout.
image::10_endergebnis.png[]

■