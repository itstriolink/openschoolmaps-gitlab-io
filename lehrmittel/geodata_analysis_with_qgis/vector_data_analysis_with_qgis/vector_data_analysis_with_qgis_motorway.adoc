= Practice/exercise: spatial analysis vector data - motorway
OpenSchoolMaps.ch -- Freie Lernmaterialien zu freien Geodaten und Karten
:xrefstyle: short
:imagesdir: ../../../bilder/vektordaten-analyse_autobahn
:experimental:
include::../../../snippets/lang/de.adoc[]
include::../../../snippets/suppress_title_page.adoc[]

Impact assessment of a motorway construction with QGIS 3

.Kartendarstellung des Analyse-Ergebnisses. Siehe auch <<endergebnis-image>>
image::11_endergebnis_ausschnitt.png[pdfwidth=100%]


== General information

The assessment of impairments of legally protected biotope types 
by traffic structures is a typical task of landscape planning.
The task is based on the construction of the A44 through 
the German Lichtenau plateau without using the original data.

.Contents

* Effects of a motorway section on habitat types
* Access to geodata processing
* Working with buffers and intersections

.Reference
This task is mainly based on http://www.gkg-kassel.de/pdf/aufgabe_6.pdf[Task 6] 
of the course "`Introduction into GIS and digital cartography`" 
by http://www.gkg-kassel.de[Claas Leiner], Uni Kassel, 2010.


== Goals and specifications

The aim of this exercise is to assess the impact of motorway construction
on habitat types Fauna-Flora-Habitat (FFH for short, a European legislative directive,
see https://de.wikipedia.org/wiki/Richtlinie_92/43/EWG_(Fauna-Flora-Habitat-Directive)[Wikipedia])
and legally protected biotope types.

The working data are polygon vector data (layer "`environment`" in geopackage
`autobahn_inputs.gpkg`) with the results of a biotope type and usage mapping,
lines vector data (layer "`autobahn_central line`" in geopackage
`autobahn_inputs`).gpkg`) with the central line of a fictitious motorway
route and the topographic map 1:25'000 (Tk25) (file `heli.tif`) as background.

In the functional data table of "Environment", 
pieces of usage (impacts) that are to be assigned 
to a habitat type (ffh_typ_nr) are marked (ffh_typ_text).
Likewise, specially protected biotope types according to
federal law (abbreviated to BNatSchG) (field "`geschuetzt_biotop`")
and other types of species-rich grassland ("`bedeutend_gruenland_typ`")
are labelled.

You should determine the size of the valuable area from the point of view
of species and biotope conservation that is completely
destroyed or impaired by motorway construction.
To answer this question, you can use the `buffer tool`
to To identify degradation zones at different distances
from the central line, which are further intersected 
with biotope type mapping to identify degraded and unimpaired areas.

Finally, the results could be entered in a table 
as an area balance (optional).


.Aids

* QGIS (tested with QGIS 3.4)
* Data:
** `autobahn_inputs.gpkg`
** `heli.tif`

<<<


== Tasks

=== Preparation: Creating the project file and loading the input data

1. Open QGIS and make sure that no existing project is open.
   (So only either a new, still empty and unsaved project or none at all.)
2. Load `autobahn_inputs.gpkg` with both vector layers included.
3. If no project was open yet, a (not yet saved)
   one has been created automatically.
   Make sure that in the project settings the coordinate reference
   system (KBS) is set to the German DHDN Gauss-Krüger Zone 3 (EPSG:31467).
   (This should be the case automatically after loading the layers.)
4. Open the project settings via the menu "Project > Properties...",
   give the project the title "Motorway and habitat types" under the
   tab "`General`" and save it under the name `Autobahn_Lebensraumtypen.qgz`
   or `Autobahn_Lebensraumtypen.qgs`.


=== Task 1: Presentation of land use

1. Classify layers "environment" using the attribute
   bfn_biotop_text to get an overview of the biotope types.
   A coarser representation of land use can be achieved by
   classifying land use according to the "Use" field.
   Work out a meaningful representation using colors
   and textures. Present your classification as a map.
2. Create a map layout and export it as `biotoptypen.pdf`.
   If you are using textures, you should check the "Print
   as raster" box on the "`General > Print quality`" tab
   in the print composition before exporting.


=== Task 2: Displaying the motorway central line and creating the buffer zones

Let's now turn to the motorway central line in Layer autobahn_zentrallinie.

[start=5]
5. Make the line clearly visible.

6. The motorway body measures 40m in total.
For a two-dimensional representation you have to create
a buffer polygon with a distance of 20 m from the center line on both sides.
+
You can do this via the menu "Vector > Geoprocessing Tools > Buffer".
The "Input layer" is the "Motorway central line", the "Distance" is 20 meters.

7. We want to record the result of this process in a file.
To save it as a layer in a new file, click the btn:[...]
button next to the layer name field and choose
menu:Save{sp}as{sp}Geopackage...[].
Name the new file `autobahn_analyse.gpkg` and the new layer trasse_20.

8. Execute the processing with the button btn:[Start].
+
Now you see the highway body in your study area.

9. Auch wenn der Layer in der neuen Datei nun `trasse_20.gpkg` heisst,
wurde er in QGIS evtl. mit "`Gepuffert`" beschriftet.
Benenne ihn gegebenenfalls in "`trasse_20`" um.
Das ist über die Layer-Eigenschaften möglich,
auf die du z.B. über das Kontext-Menü
des Layer-Eintrags im Layer-Panel gelangst.

10. Die Beeinträchtigungen der Autobahn reichen über die Autobahn-Trasse hinaus.
Deshalb musst du noch weitere Pufferzonen erzeugen.
+
--
Erstellen Sie, ausgehend von der eben erstellten Trasse, zwei weitere "`Puffer`":

** Einen mit dem Abstand 100 m als *Temporärlayer* trasse_20_puffer_100
** Einen mit Abstand 300 m als *Temporärlayer* trasse_20_puffer_300.
--
+
trasse_20_puffer_100 kennzeichnet
die unmittelbar an die Autobahn angrenzenden Bereiche,
in denen von grossen Beeinträchtigungen
durch Abgase, Lärm und Abwasser auszugehen ist.
Die Fläche trasse_20_puffer_300 umfasst den weiteren Eingriffsbereich
bis zu einer Entfernung von 300 m von der Autobahn.

11. Auch hier kann es sein,
dass die im Hintergrund für die Layer erstellten Temporär-Dateien
zwar wie verlangt heissen,
die Layer in QGIS aber als "`Gepuffert`" aufgeführt sind.
Benenne sie entsprechend um.

.QGIS-Dialog zu Puffer.
image::02_qgis-puffer-dialog.png[]


=== Task 3: Create Ring Zones Excluding the Buffer Zones

Alle erstellten Pufferpolygone
umfassen die gesamte Fläche zwischen Ihren Aussengrenzen.
Die grossen Pufferflächen überdecken die kleinen Zonen.
Wir benötigen aber Polygone in Form von einander anschliessenden Zonen,
die sich nicht überschneiden.
Um dieses Ziel zu erreichen,
verwenden wir versuchshalber das Werkzeug "`Differenz`".
Nach den nun folgenden Verschneidungsprozessen
verfügst du über den Autobahnkörper
sowie über zwei sich ausschliessende
und aneinander anschliessende Schalen um die Autobahn.

Erstellen der äusseren Beeinträchtigungszone
(von 100 m bis 300 m Entfernung von der Autobahn):

[start=12]
12. Die Fläche des Puffers trasse_20_puffer_100
ist aus dem Puffer trasse_20_puffer_300 herauszuschneiden,
um die äussere Beeinträchtigungszone abzugrenzen.
+
Dies ist mit der Menü-Option
"Vektor > Geoverarbeitungswerkezeuge > Differenz" zu erreichen.

** "`Eingabelayer`" = trasse_20_puffer_300
** "`Layer überlagern`" = trasse_20_puffer_100

13. Speichere das Ergebnis
in der nun schon bestehenden Datei `autobahn_analyse.gpkg`
als neuen Layer zone_100_300.

14. Auch hier kann es sein,
dass QGIS den Layer zwar unter den richtigen Namen speichert,
aber ins Projekt selbst als "`Differenz`" einbindet.
Benenne ihn gegebenenfalls in zone_100_300 um.

.Dialog "`Symmetrische Differenz`".
image::03_qgis-differenz-dialog.png[]

Erstellen der inneren Beeinträchtigungszone
(von der Trasse bis 100 m Entfernung von der Autobahn).

[start=15]
15. Die Fläche des Puffers trasse_20
ist aus dem Puffer trasse_20_puffer_100 herauszuschneiden,
um die innere Beeinträchtigungszone abzugrenzen.
Speichere sie als Layer zone_100 ebenfalls in `analyse.gpkg`
und benenne den Layer in QGIS gegebenenfalls entsprechend um.
** "`Eingabelayer`" = trasse_20_puffer_100
** "`Layer überlagern`" = trasse_20

The following layers are now important:

* The two layers with the input data
* The actual 40 metre wide route: trasse_20
* The zone from the route to a distance of 100 m: zone_100
* The zone at a distance of 100 m up to 300 m from the route: zone_100_300

If everything went fine, you can hide or delete
the two temporary layers for a better overview:

* route_20_buffer_100
* route_20_buffer_300


=== Task 4: Merge the three zones into one layer

With the Merge tool,
any number of geometries can be
merged into one layer in one step.

1. Select menu:Merge vector layer{sp}
from the menu "Vector > Data management tools"...[]

2. Choose as the input layer:
** route_20
** zone_100
** zone_100_300

3. Save the result in `autobahn_analyse.gpkg` as layer "`zones`".

4. Also here it can be that QGIS integrates the new
layer under a generic name (here: "merged").
Rename it to `zones` if necessary.


=== Task 5: Edit the attribute table of the vector file `all_zones.shp`.

Der neue Layer verfügt noch
über keine sinnvollen Attributtwerte für die einzelnen Beeinträchtigungszonen.
Damit du die Fläche unterschiedlich bewerteter Biotoptypen
in den Beeinträchtigungszonen ermitteln kannst,
musst du den Zonen einen Attributwert zuweisen.
Bearbeite die Attributtabelle in den Layer-Eigenschaften

1. Öffne das Kontext-Menü des Layers "`zonen`"
   und wähle menu:Eigenschaften…[].
2. Wähle im Layereigenschaften-Fenster den Reiter "`Quellfelder`" an.
3. Schalte den Bearbeitungs-Modus an (Knopf mit dem Stift)
4. Lösche alle Felder ausser "`layer`" und "`fid`".
5. Benenne das Feld "`layer`" in "`zone`" um.
6. Schliesse das Layereigenschaften-Fenster mit btn:[OK].
7. Öffne das Kontext-Menü des Layers "`zonen`"
   und wähle menu:Attributtabelle{sp}öffnen[].
8. Ändere die Werte in Spalte "`zone`" wie folgt:
** trasse_20 -> Trasse
** zone_100 -> Innen
** zone_100_300 -> Aussen
9. Du kannst anschliessend die überstehenden End-Rundungen der Puffer
   mit dem Zeichenwerkzeug "Bearbeiten > Objekte zerteilen" abschneiden
   (der Schnitt-Linienzug kann mit Rechtsklick abgeschlossen werden),
   diese Restflächen über "Bearbeiten > Auswahl > ..." auswählen
   und die Restflächen dann
   mit der Funktion "Bearbeiten > Ausgewähltes Löschen" löschen.
10. Speichere den Layer (Menü "Layer > Bearbeitungsstatus umschalten")
    und klassifiziere die Zonen.
    Nutze Schraffuren oder Punktdichteraster,
    um die darunter liegenden Ebenen nicht vollständig zu verdecken.


=== Aufgabe 6: Abfragen aller naturschutzfachlich hervorragenden Flächen

Nun sollen alle naturschutzfachlich bedeutenden Flächen
aus dem Layer Umgebung abgefragt werden.
Dabei handelt es sich
um Lebensraumtypen des Anhangs 1 der FFH-Richtlinie (ffh_typ_nr),
um besonders geschützte Biotoptypen gemäss BNatSchG (geschuetzt_biotop)
und
um sonstige Biotoptypen des artenreichen Grünlands (bedeutend_gruenland_typ).

Gehe wie folgt vor:

1. Wähle den Layer "`umgebung`" im Layer-Panel aus.

2. Öffne die Attributtabelle ("Layer > Attributtabelle öffnen"),
um dir einen Überblick zu verschaffen.
(Danach kannst du die Attributtabelle wieder schliessen.)

3. Öffne über die Menü-Option "Layer > Filter…" den Abfrageeditor.

4. Stelle mit Hilfe der Schaltflächen im Abfrageeditor
eine Abfrage zusammen, mit der du alle Flächen auswählst, die entweder
FFH-Lebensräume sind (`ffh_typ_nr = 1`),
geschützte Biotope beinhalten (`OR geschuetzt_biotop = 1`)
oder bei denen es sich um einen sonstigen bedeutenden Grünlandtypen handelt
(`OR bedeutend_gruenland_typ = 1`).
+
Anmerkung:
In den betreffenden Spalten der Attributtabelle
bedeutet der Wert `1` jeweils "`trifft zu`".
+
Ihr SQL-Befehl muss folgendermassen aussehen:
+
[source,sql]
----
ffh_typ_nr = 1 OR geschuetzt_biotop = 1 OR bedeutend_gruenland_typ = 1
----

5. Teste die Abfrage.
+
Die Auswahl sollte 43 Polygone enthalten.

6. Bestätige mit btn:[OK].
Dadurch wird der Filter auf den Layer angewandt
und das Abfrageerstellungsfenster geschlossen.
Du siehst jetzt alle Flächen,
die aus Sicht des Biotop- und Artenschutzes wertvoll sind.

7. Speichere die/den gefilterten Layer über "Layer > Speichern als…"
im Geopackage `autobahn_analyse.gpkg` als Layer "`wertvoll`" ab.
Danach kannst du den Filter auf Layer "`umgebung`" wieder löschen.

.Dialog.
image::06_qgis-abfrage-ergebnis.png[]


=== Aufgabe 7: Schnittmenge zwischen wertvollen Flächen und Beeinträchtigungszonen

Als nächstes sind jene naturschutzfachlich wertvollen Flächen zu ermitteln,
die in den drei Beeinträchtigungsszonen liegen.
Du benutzt das Werkzeug "`Verschneidung`" (Intersect),
um die Layer wertvoll und zonen miteinander zu verschneiden.
Der resultierende Layer enthält ausschliesslich Flächen,
die naturschutzfachlich wertvoll sind
und die gleichzeitig durch den Autobahnbau zerstört oder beeinträchtigt werden.

1. Mit der Menü-Option
"Vektor > Geoverarbeitungswerkzeuge > Verschneidung…"
verschneidest du beide Layer.
** "`Eingabelayer`": zonen
** "`Layer überlagern`": wertvoll
** Ziel-Layer: *_unbenannter_ Temporärlayer*

2. Ein Klick auf btn:[Starte] führt zu folgender Fehlermeldung:
+
____
Objekt (24) hat ungültige Geometrie.
Bitte diese Fehler korrigieren oder
die Verarbeitungseinstellung auf "`Ungültige Eingabeobjekte ignorieren`".

Ausführung nach 0.01 Sekunden gescheitert
____
Öffne die QGIS-Optionen über Menü "Einstellungen > Optionen…"
und ändere unter Reiter "`Verarbeitung`" > Abschnitt "`Allgemein`"
die entsprechende Einstellung "`Filterung ungültiger Objekte`"
von "`Algorithmenausführung bei ungültiger Geiometrie anhalten`"
auf "`Objekte mit ungültiger Geometrie ignorieren.`"

3. Wiederhole nun die Verschneide-Operation.
Nun sollte sie gelingen.
Die Fehlermeldung kommt zwar trotzdem,
aber mit "`abgeschlossen`" anstatt "`gescheitert`".

4. Der resultierende Layer ist in QGIS vermutlich
unter dem Namen "`Verschneidung`" eingebunden worden.
Benenne ihn in "`intersect_wertvoll`" um.

5. Öffne die Attribut-Tabelle des neuen Layers.
Die Werte der "`fid`"-Spalte des 2. Input-Layers ("`wertvoll`")
finden sich in der Spalte "`fid_2`" des neuen Layers wieder.
Die "`fid`"-Spalte des 1. Input-Layers (zonen)
wird im Resultat jedoch als "`fid`"
wird in "`intersect_wertvoll`" jedoch als "`fid`" wiedergegeben,
was problematisch ist,
da QGIS diesen Spaltennamen defaultmässig
als PK z.B. von GeoPackage-Layern nimmt,
die Werte durch die Verschneidung nun aber alles andere als UNIQUE sind.

6. Benenne die "`fid`"-Spalte
von "`intersect_wertvoll`" in "`fid_zone`" um
und beende den Bearbeitungs-Modus.

7. Über sein Kontext-Menü kannst du
Layer "`intersect_wertvoll`" nun permanent machen.
Speichere ihn als "`intersect_wertvoll`" in `autobahn_analyse.gpkg`.
Stelle sicher, dass der im Feld "`FID`" angegebene Name
keiner schon bestehenden Spalte entspricht.

8. Nun kannst du in der Attributtabelle des Layers "`intersect_wertvoll`"
(Menü "Layer > Attributtabelle öffnen")
oben rechts den "`Feldrechner`" betätigen.
Dieser erlaubt es dir, ein neues Feld anhand einer "`Expression`" anzulegen.
Verwende folgenden Ausdruck, um mit QGIS
die Fläche unseres Polygons zu berechnen,
welche dann durch 100 geteilt wird,
um die Quadratmeter in Aren umzurechnen.
Das Resultat wird letztlich auf 1 signifikante Stelle nach dem Komma gerundet.
Ausdruck: round($area / 100, 1)

9. Set "`area`" as "`output field names`" and select
the "`output field types`" "`decimal number (real)`".
Confirm with btn:[OK] and check if a column
with the name "`area`" has been created.

10. Now in the column "`area`" you can find the
exact areas of the polygons in ares.

11. Save the new column by deactivating the edit
mode for the intersect_value layer.


=== Task 8: Classify vector files and create maps

Afterwards you should present your newly created
geometries as meaningful maps.
You should present the valuable biotope
types in the impairment zones or the conflict zones as a map.

1. Classify Layer intersect_valueful by attribute ffh_typ_text (click on btn:[Classify]).
2. Delete the empty value.
3. The layer now displays all areas within the affected 
   zones where FFH-relevant biotope types are located.
4. Filter Layer intersect_valueful with the help of 
   the query editor with the query ffh_typ_nr = 0.
5. Save the selection via "Layer > Save as..."
   under the layer name "`intersect_valueful_without_ffh`"
   in `autobahn_analyse.gpkg`.
6. Load the new layer and classify it by bfn_biotop_text
7. Delete the empty value and you get three classes of valuable non-FFFH biotopes.
8. Load the enclosed raster file `heli.tif` and move it to the bottom of the table
   of contents. Then adjust the global transparency in the layer properties of
   `heli.tif` so that the raster layer can serve as a weakly visible background.
9. Now you can create a map which shows the valuable biotope types affected by
   the motorway construction and additionally highlights the ffh_typ_nr.
10. Create a map layout and export it as PDF. 
    (Activate before under General: "`Print as Raster`")
11. You can see an example of a possible map display on the following page.
    But you don't have to create a layout with two cards.
    It is enough if you decide on a content statement and visualize
    it in a meaningful map layout.


=== Closure

The following files must now be present:

* The simple biotope type map.
* A finished map layout in PDF format, which represents either
  the valuable biotope types in the area of impairment or the
  conflict zones from the point of view of biotope and species protection.

[[endergebnis-image]]
.Darstellung des des Analyse-Ergebnisses in einem Beispiel-Layout.
image::10_endergebnis.png[]

■