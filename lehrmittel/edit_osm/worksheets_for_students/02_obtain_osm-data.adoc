= Obtain OpenStreetMap-Data and use it with QGIS 3
OpenSchoolMaps.ch - Free learning materials for free geodata and maps
:xrefstyle: short
:imagesdir: ../../../bilder/
include::../../../snippets/suppress_title_page.adoc[]

A guide for the interested, for pupils and for instructors/teachers

== Overview

.Goal
The goal of this guide is to show how to get OpenStreetMap data and use it in QGIS 3.

.Audience
Anyone who is interested in creating their own map (online, as a printable plan) 
and in analysing geodata.

.Scheduling
This worksheet requires different amounts of time depending on your previous 
knowledge, since you can skip individual sections if you are already familiar 
with the topic in question.

.Structure
The following topics will be covered:

* Introduction with explanations of OpenStreetMap and geoinformation 
systems as well as common file formats
* Extract OpenStreetMap data with Overpass
* Import OpenStreetMap data directly into QGIS with QuickOSM plugin
* Various web tools for downloading OpenStreetMap data
* Merging Polygon Layers with Point Layers in QGIS
* Filtering or rule-based display of objects with QGIS

We recommend at least reading the introduction and extracting the 
chapter OpenStreetMap data with overpass.

[NOTE]
====
This tutorial is about using existing data from OpenStreetMap. 
If you want to record data yourself, you can use the worksheets 
"Edit OpenStreetMap" and "Create a thematic online map with uMap" 
as well as https://learnosm.org/de/ for more information.
====

== Introduction

The data from OpenStreetMap comes in different data formats.
Therefore we will first explain some of these file formats in more detail.

=== OpenStreetMap and geoinformation systems

The geometry of the objects in OpenStreetMap (OSM) are stored internally 
as topological structures (nodes, ways). 
And the object attributes as tags (key-value pairs) only partially structured. 
This data schema, which can be extended at will, must first be converted for 
geoinformation systems (GIS) and their formats. 
There is no single GIS data schema for OSM. 
Hardly any export from OSM is therefore the same as the other.

=== File formats

Basically, one can distinguish between OSM's own and analyzable GIS formats.

* OSM-specific formats are mainly OSM XML, and OSM PBF.
* GIS compatible formats are GeoJSON, Geopackage (and related: MBTile/SQLite), 
Shapefiles, GeoJSON (TopoJSON).
* Other GIS vector formats are: KML and GPX for GPS data exchange.
* Other formats that cannot be analysed further are image/raster formats such as PNG, JPEG, SVG and PDF.

The following describes various methods for importing OpenStreetMap data into QGIS. 
The first method works with Overpass-Turbo, a web service for querying OpenStreetMap data. 
We recommend that you look at this method as it is the most efficient of all the methods presented. 
The second method is based on QuickOSM, a plugin for QGIS in which queries can be created. 
If you've read or read the overpass turbo section, you can consider it optional with QuickOSM. 

After the two inport methods further tools are introduced, for example the HOT Export Tool or OSMaxx. 

Finally, you will learn how to merge different layers in QGIS. 
This chapter is referred to at the end of the remaining chapters, so you'll come there for or after.

== Extract OpenStreetMap data with Overpass

The easiest and fastest way to import OpenStreetMap data into QGIS is by overpass turbo. 
This method is suitable for advanced as well as for beginners. First visit the Overpass-Turbo 
website at: http://overpass-turbo.osm.ch/.

When you first visit the website, it looks something like this:

.Startseite von Overpass-Turbo
image::osm_editieren/osm-daten_beziehen/startseite.PNG[]

Click on the red marked "Wizard" button. The wizard makes it easy to create overpass queries. 
Since we are looking for bread outlets as an example, we are looking for bakeries and 
supermarkets as both sell bread. As a locality we take Uster as an example. 
The query looks like this (_bakery or supermarket in Uster_):

.Overpass-Turbo Wizard-Abfrage
image::osm_editieren/osm-daten_beziehen/wizardAbfrage.PNG[]

After clicking on "Create and execute query" you will get the following:

.Resultat der Wizard-Abfrage
image::osm_editieren/osm-daten_beziehen/resultat.PNG[]

The above result can also be simplified by replacing the "nodes", "ways" and 
"relations" to "nwr" (=noses/ways/relations). In the lower right corner you can 
see the different objects marked in red. We have 22 POIs and 5 polygons. 
Since we only want POIs, we could use "out center;" to turn all areas and paths into points. 
The new query should look like this.

    [out:json][timeout:25];
    {{geocodeArea:Uster}}->.searchArea;
    (
        nwr["shop"="bakery"](area.searchArea);
        nwr["shop"="supermarket"](area.searchArea);
    );
    out center;

If we now copy the upper lines and paste them into the overpass turbo 
as a query and execute them, we get the following:

.Ãœberarbeitetes Resultat
image::osm_editieren/osm-daten_beziehen/resultatNeu.PNG[]

Now we see in the lower right corner that the displayed objects consist only of POIs. 
We now have 27 POIs and 0 polygons, because we have converted the 5 polygons to POIs 
via "out center" and Overpass has added these 5 new POIs to the existing 22 POIs. 
Now we have to save the query as GeoJSON. To do this, go to "Export" in the upper 
left corner of "Wizard". The window that appears gives us various export options: 
We choose the top one, i.e. "Save as GeoJSON".

.Overpass Export
image::osm_editieren/osm-daten_beziehen/overpass_export.PNG[]

We now add the downloaded GeoJSON file to the left layer menu in QGIS using Drag & Drop. 
In addition, we rename the layer appropriately, for example "Bread outlets".

Our QGIS now looks like this:

.GeoJSON in QGIS importiert
image::osm_editieren/osm-daten_beziehen/brotverkaufsstellen_QGIS.PNG[]

As you have probably noticed, an OSM standard layer is used here as a 
background to present the data more clearly. I assume that you don't have this one, 
but that's not too bad, because it's not absolutely necessary. So you can continue 
without OSM standard layer as background.

Finally, we want to change the coordinate system of the GeoJSON imported into QGIS 
and save it as a GeoPackage. To do this, right-click on the layer, go to "Export" 
and select the top entry "Save Feature As...". We change the KBS to "EPSG:2056 - 
CH1903+/LV95" and give the file a name. We leave the format as GeoPackage and click on "OK".

Below you can see the export window:

.Als GeoPackage exportieren
image::osm_editieren/osm-daten_beziehen/brotverkaufsstellen_gpkg.PNG[]

Very good, you managed to import OpenStreetMap data into QGIS and save it as a new format. 
The other way to import OpenStreetMap data into QGIS is using the QuickOSM plugin, 
which is explained below. If you are not interested or have already read it, you can jump 
to the chapters "Merging Polygon Layers with Point Layers in QGIS" or 
"Filtering Objects with QGIS or Rule-Based Displaying".

== Import OpenStreetMap data directly into QGIS with QuickOSM plugin

Now let's look at another way to import and manage OpenStreetMap data into QGIS. 
It is best to delete the previously created layer and start at zero to avoid confusion.

.QGIS
image::osm_editieren/osm-daten_beziehen/osm_in_qgis.PNG[]

