# Apache Superset für Fortgeschrittene
:imagesdir: ../../bilder/
include::../../snippets/lang/de.adoc[]
include::../../snippets/suppress_title_page.adoc[]

Ein Arbeitsblatt für Interessierte und Lehrpersonen _(WIP = Work-in-progress)_.

## Übersicht

Dieses Arbeitsblatt ist eine Fortsetzung der "Einführung in Apache Superset": 

Dieses Arbeitsblatt hat folgende Lernziele:

* Karten-Typen
* Chart Parameter anpassen
* ToolTips mit JavaScript anpassen
* Annotations

## Bevor Daten visualisiert werden...

Visualisieren bedeutet Daten auf grafische Symbole oder Diagramme abzubilden. Auch Apache Superset ist so aufgebaut: Der Visualisierungs-Prozess beginnt mit der Wahl der Datenquelle (Tabelle), dann wird ein passender Chart ausgewählt, und schliesslich wird der Chart einem Dashboard zugeordnet.

Datentypen helfen, die Entscheidung zur Auswahl eines Charts oder Kartentyps zu vereinfachen. Zu Beginn dieses Visualisierungs-Prozesses lohnt es sich, sich mit den Daten vertraut zu machen. Das ist die Domäne der beschreibenden Statistik und des Data Engineerings. Wer die Merkmale eines Attributs kennt, findet die in Frage kommenden Charts schneller.

*Qualitativ und quantitativ*: Man unterscheide zwischen qualitativen und quantitativen Attribut-Merkmalen. Qualitative Merkmale sind solche, die sich nicht durch Zahlen direkt erfassen lassen; deren Datentyp ist meist Text. Beispiele dazu sind Vornamen, Firmennamen, etc. Quantitative Merkmale dagegen sind durch Zahlen bestimmbar. Diese Merkmale lassen sich durch wiegen, messen, abzählen usw. bestimmen.

*Attributs-Merkmals-Levels*: Die quantitativen Merkmale lassen sich ihrerseits differenzieren in vier "Attributs-Merkmals-Levels" (Quelle: Stanley Stevens, 1946, "One the theory of Scales of Measurement"):

* Nominal: Ein Name, Klassenname ("etwas Benanntes"). Meist Datentyp Text.

* Ordinal: Eine Ordnungszahl, eine Rangierung, ("etwas zum Vergleichen"). Meist Datentyp Ganzzahl.

* Intervall: Ein massstabsloser Zahlenwert, Verhältniszahl ("etwas Relatives"). Meist Datentyp Fliess- oder Festkommazahl.

* Ratio: Ein Zahlenwert mit absolutem Nullpunkt; meist Datentyp Fliess- oder Festkommazahl.



**Datentypen und Datentyp-Rollen**

Ein Datentyp bestimmt den erlaubten Wertebereich. Ein Beispiel für einen Datentyp ist die Ganzzahl. Superset kennt folgende *Basis-Datentypen*:

* Zeichenkette (en: Text). In Superset mit dem Icon "ABC" dargestellt. Das können z.B. die PostgreSQL-Typen TEXT oder VARCHAR() sein.

* DatumZeit (en: Datetime) In Superset mit dem Icon "Uhr" dargestellt. Ein "temporaler" d.h. ein zeitlicher Typ mit Datums- und Zeitwert.

* Zahl (en: Number). In Superset mit dem Icon "#" dargestellt. Das sind in Apache Superset Ganzzahlen (INTEGER).

* Fliesskomma (en: float/real) und Festkommazahlen (numeric) erhalten in Superset keine Icons.

* Metrik (en: Metrics). In Superset als "f" dargestellt. Aggregations-Typ, z.B. COUNT(\*). Superset fügt bei Tabellen immer das abgeleitete Attribut COUNT(*) dazu.

Zeitliche Daten sind wichtig in jeder Datenanalyse. Sie werden u.a. zum Filtern der Daten verwendet. Die Tatsache, dass ein Attribut vom Typ DatumZeit ist, wird durch dessen Attributtyp direkt in der Datenbank-Tabelle bestimmt, zusätzlich zu der Kennzeichnung als temporaler Typ, die in Superset noch manuell gesetzt werden muss. (Bei der Checkbox _is temporal_ unter _Columns_ bei der Tabellenansicht)

Es existieren mehr Basis-Datentypen als diejenigen aus Apache Superset, die oben erwähnt wurden. Superset verlangt darum bei vielen Charts oft zusätzlich noch die Angabe einer *Datentyp-Rolle* (en: Data type role) wie beispielsweise "Lines" (Linien).

Mit der Angabe der Datentyp-Rolle zu einem Text-Attribut ist es immer noch nicht getan: Es muss noch das *Datentyp-Encoding* (encoding = Kodierung) bestimmt werden. Superset kennt verschiedene Datentyp-Rollen und Datentyp-Encodings. Weitere werden sicherlich dazu kommen.



**Räumliche Daten (Geodaten)**

Wie die zeitlichen (en: temporal) sind auch die räumlichen (en: spatial) Daten wichtig bei der Analyse und Visualisierung. Geometrien sind dabei nicht die einzigen räumlichen Daten, auch Gemeindenamen und Gebäudeadressen sind Geodaten.

Die wichtigsten Geometrie- bzw. *Geodatentypen* (en: Geometry) sind Punkt (Syn. Koordinate; Punktkoordinate; Ort; en: Point), Linie (en: Line, Linestring, Polyline), Fläche (en: Area, Polygon) und Volumen (en: Volume). In dem der Benutzer die Datentyp-Rollen angibt, ist es mit Superset möglich, auch räumliche Daten zu visualisieren.

NOTE: Attribute, die in der Tabelle bereits als Typ Point, Linestring und Polygon verwaltet sind, werden von Superset (noch) als Text oder Binärdaten interpretiert.

Geo-Datentyp-Rollen und Datentyp-Encodings in Apache Superset:

* Geo-Datentyp-Rolle "Longitude & Latitude columns": Zwei untrennbar miteinander verbundene Attribute in der Tabelle, Längengrad und Breitengrad, die vom Datentyp Fliesskomma (z.B. Fliesskommazahl FLOAT8) sind. Diese Rolle ist eine Variation der Datentyp-Rolle "Point".

* (Eine Geo-Datentyp-Rolle "Point" gibt es noch nicht, ist aber vorreserviert).

* Geo-Datentyp-Rolle "Lines": Das sind Attribute vom Basis-Datentyp Text (ABC in Superset), die als "JSON" oder als "Polylines" codiert sein können.

* Geo-Datentyp-Rolle "Polygons": Das sind Attribute vom Basis-Datentyp Text (ABC in Superset), die als "JSON", als "Polylines" oder als "Geohash" codiert sein können.

NOTE: Für Positionsangaben auf der Erde - beispielsweise mit dem GPS - werden Längengrade und Breitengrade verwendet (abgekürzt: Lat/Lon). Sie basieren auf einem weltweit einheitlichen, geodätischen Koordinaten-Referenzsystem, dem World Geodetic System 1984 (WGS 84). Lat/Lon werden oft als Fliesskommazahlen behandelt. Dabei würde für die meisten Anwendungen eine Festkommazahl mit 5 bis max. 6 Nachkommastellen genügen (Beispiel von Lat/Lon für Rapperswil, dass man auf https://www.osm.org[www.osm.org] prüfen kann: 47.22666, 8.81644).



**Kartentypen und Superset (Map) Charts**

In der Geovisualisierung wird der oben beschriebene Visualisierungs-Prozess auf Geodaten und Karten angewendet. Hier werden die Geodaten den Kartensymbolen zuordnet und man spricht von Symbolisierung (en: symbolization, styling).

Es gibt folgende Kartentypen:

* Standortkarten
* Netzkarten
* Choroplethenkarten
* Ortsdiagrammkarten

Die Kartentypen aus der Kartografie helfen, die Superset Map-Charts zu gruppieren. Es werden hier nur die bekanntesten Kartentypen vorgestellt. Auch Superset deckt nicht alle Kartentypen ab, kennt aber zurzeit schon zwölf verschiedene Map-Chart-Typen (vgl. auch der Anhang):

*Standortkarten* (en: Dot Map) werden symbolisiert mit Punktsignaturen (beispielsweise rote Symbole/Marker) bezogen auf Punkte/Orte. Zu diesem Kartentyp gehören folgende Superset Charts:

* Mapbox: Standortkarte mit Point Clustering. Erwartet die Datentyp-Rolle "Longitude & Latitude columns".

* Deck.gl Scatterplot: Standortkarte ohne Point Clustering. Erwartet die Datentyp-Rolle "Longitude & Latitude columns".

NOTE: Unter Point Clustering versteht man das "Verschmelzen" von Punkten beim Herauszoomen. Siehe Abbildung 1 und 2 im Anhang.

*Netzkarten* (en: Network map) (deutsches Synonym: Vektorkarten), werden symbolisiert mit Liniensignaturen (beispielsweise rote Linien) bezogen auf Linien. Zu diesem Kartentyp gehören folgende Superset Charts:

* Deck.gl Path: Netzkarte. Erwartet die Datentyp-Rolle "Lines".

* Deck.gl Arc: Netzkarte mit Linien, die aus 2 Endpunkten bestehen und die Kurven kürzester Distanz auf der Erdoberfläche (Orthodrome) darstellen, beispielsweise zur Visualisierung von Flügen oder Schiffswegen. Erwartet die Datentyp-Rolle "Longitude & Latitude columns".

*Choroplethenkarten* (en. Choropleth Map) (deutsche Synonyme: Dichtemosaikkarten; Flächenkartogramme) werden symbolisiert mit Flächensignaturen bezogen auf Flächen. Die Werte sind hier meist nicht absolut, sondern relativ. Zu diesem Kartentyp gehören folgende Superset Charts:

* Country Map: Choroplethenkarte mit Ländergrenzen. Erwartet ISO-codes von Departements/Kantone/etc (admin_level=4) als Zeichenkette.

* Deck.gl Polygon: Choroplethenkarte mit Flächen. Erwartet die Datentyp-Rolle "Polygons".

NOTE: Ein häufiger Fehler in Choroplethenkarten ist, wenn die dargestellten Werte absolut sind, beispielsweise "Summe der Traktoren pro Land". Richtig wäre eine relative Angabe wie "Traktoren pro km2", d.h. die absolute Summe durch die Landesfläche geteilt werden.

*Ortsdiagrammkarten* (en. Symbol Map) werden symbolisiert mit lokalen Business-Diagrammen bezogen auf Orte bzw. Flächen. Man beachte den Unterschied von Symbol/Marker zu Diagramm. Zu diesem Kartentyp gehören folgende Superset Charts:

* World Map: Ortsdiagrammkarte 2D. Erwartet ISO-codes von den Ländern als Zeichenkette.

* Deck.gl 3D Hexagon: Ortsdiagrammkarte 3D. Erwartet die Datentyp-Rolle "Longitude & Latitude columns".

* Deck.gl Grid: Variante von Deck.Gl 3D Hexagon jedoch mit rechteckigen Säulen. Erwartet die Datentyp-Rolle "Longitude & Latitude columns".

* Deck.gl Screen Grid: Ähnlich wie Deck.GL Grid und Hexagon. Erwartet die Datentyp-Rolle "Longitude & Latitude columns".

* Deck.gl GeoJSON: (Bemerkung: Funktioniert in Superset momentan nicht!).

Ein weiterer Map-Chart ist *Deck.gl Multiple Layers*. Dieser "Chart" erlaubt die Kombination von mehreren Deck.gl-Charts zusammen mit einer Basiskarte.

NOTE: Dies ist nur eine Auswahl der wichtigsten Kartentypen. Sie ist unvollständig. Eine mögliche Quelle zum Nachlesen ist https://www.gitta.info/[GITTA.info].



**Zuordnung von Geodaten zu Kartentypen**

Die Tabelle unten zeigt die Zuordnung von Geometrie-Datentypen auf der horizontalen Achse und Attributs-Merkmals-Levels auf der vertikalen Achse zu Kartentypen:

|===

| |**Point** |**Line** |**Area**

|**Nominal**
|Dot map
|Network map
|Colored area map

|**Ordinal**
|Symbol map
|Ordered network map
|Ordered colored map

|**Interval**
.2+|Graduated symbol map
.2+|Flow map
.2+|Choropleth map

|**Ratio**

|===

Figur: Tabelle, die Geometrie-Datentypen und Attributs-Merkmals-Levels zu Kartentypen zuordnet. (Quelle: David Unwin, 1981, “Introductory Spatial Analysis”, London Methuen).

## Chart-Parameter anpassen

### Dashboard-Optionen

Ein Dashboard kann die Darstellungs-Konfiguration (z.B. Chart-Farben) der Charts überschreiben. 
Das ist möglich, indem man die Metadaten eines Dashboards editiert. Die Einstellungen findet man unter _Dashboard-> Edit record_. 
Hier wirst du ein Textfeld namens "JSON Metadata" finden. Dies könnte z.B. so aussehen (es kann auch sein, dass es leer ist):

----
{
  "filter_immune_slices": [],
  "timed_refresh_immune_slices": [],
  "filter_immune_slice_fields": {},
  "expanded_slices": {},
  "refresh_frequency": 0,
  "default_filters": "{}"
}
----

Die Parameter gelten allgemein für alle Dashboards:


* filter_immune_slices: Array von _slice_ids_ (int) von Charts, die nicht gefiltert werden sollen.
----
"filter_immune_slices": [324, 65, 92],
----
* timed_refresh_immune_slices: Array von _slice_ids_, die nicht ge-refreshed werden sollen.
----
"timed_refresh_immune_slices": [324]
----
* filter_immune_slice_fields: Hier kannst du einstellen, ob bei gewissen Charts spezifische Felder nicht filterbar sein sollen.
----
{
    "filter_immune_slice_fields": {
        "177": ["country_name", "__time_range"],
        "32": ["__time_range"]
    }
}
----
* refresh_frequency: Anzahl Sekunden bis der Browser die Daten vom Server automatisch neu lädt (Ganzzahl in Sekunden).
----
"refresh_frequency": 5
----
* default_filters: Setzt Default-Werte in den Filter. Die _slice_id_ des Filters muss gegeben sein.
----
"default_filters": "{\"95\": {\"country_name\": [\"Kenya\"]}}"
----

NOTE: Die _slice_id_ ist in den Chart Metadaten unter _Parameter_ zu finden. Falls dein Chart keine ID hat musst du ihn noch einmal abspeichern.

### Chart-Farben im Dashboard definieren

IMPORTANT: Damit die gewünschten Farben im Dashboard angewendet werden, muss bei den einzelnen Charts unter _Customize_ das Farbschema `Airbnb Colors`
gesetzt sein.

Um die Farbe von einem Chart abzuändern musst du `"label_colors": {"key": "color"},` hinzufügen. Hier ein Beispiel wie das aussehen könnte:

----
{
  "label_colors": {
    "girl": "#0200ff",
    "boy": "#00ff00"
  },
  "filter_immune_slices": [],
  "timed_refresh_immune_slices": [],
  "filter_immune_slice_fields": {},
  "expanded_slices": {},
  "refresh_frequency": 0,
  "default_filters": "{}"
}
----

Der JSON Editor Online https://jsoneditoronline.org/ kann bei der Bearbeitung helfen.

Die "Keys" wie z.B. "girl" kannst du in der Legende des jeweiligen Charts finden.


### Tooltips mit JavaScript anpassen

Jeder Punkt bei z.B. Scatterplot zeigt dessen Längengrad und Breitengrad als ToolTip-Text an. Dieser ist beim Chart unter _Advanced_ im _Javascript tooltip generator_
anpassbar. 

IMPORTANT: Für diese Anpassung muss das Schreiben von JavaScript aktiviert sein (ENABLE-JAVASCRIPT-CONTROL).
Kontaktieren Sie den Sys-Admin falls nötig.

Im Textfeld muss man eine funktion schreiben, die einen String zurück gibt, der dann als Tooltip angezeigt wird. Hier ein einfaches Beispiel, welches den Tooltip zu "test" setzt:

----
function myFunction(punkt) {
    return 'test'
}
----

Um eine sinnvolleren Tooltip zu erhalten muss man zuerst die Daten auswählen, die man nutzen will. Das geht durch das Hinzufügen von den Spalten unter _Extra data for JS_.

Wenn du jetzt für jeden Punkt dir einen Tooltip anzeigen lassen willst, mit Informationen von einer Spalte mit den Namen "Name", musst du die Funktion so schreiben: 

----
function myFunction(punkt) {
    return punkt.object.extraProps.Name
}
----

## Annotations

Annotations sind die Text- und Grafik-Notizen, die über bestimmte Charts gelegt werden können. Je nach Annotations-Typ ist es entweder eine Linie oder ein gefärbtes Rechteck im Hintergrund. Sie können dazu benutzt werden allgemeine Informationen (z.B. weltweites Bevölkerungswachstum) darzustellen ohne diese als Daten in einer Tabelle ablegen zu müssen.
Annotation Layers dienen dazu, Annotations zu bündeln. Ein Layer kann mehrere Annotations beinhalten und man bindet in Diagrammen jeweils den Annotation Layer ein, der dann alle Annotations darstellt.
Es gibt vier Annotations-Typen:

* Ereignis (en: Event): Basierend auf Tabellendaten, wird als Linie dargestellt.
* Intervall (en: Interval): Wie Event, allerdings mit Start- und Enddatum, wird als "Range" gerendert.
* Zeit (Time Series): Linie basierend auf beliebiger Time Series.
* Formel (en: Formula): Linie basierend auf einer Formel (z.B. 2x oder 0.005x).

### Erstellen von Annotationen

Ereignis- und Intervall-Annotationen 

### Ereignis-Annotationen

Ereignisse (en: Events) sind eine Liste von Zeitpunkten (Datum) mit Beschreibungen. Sie werden als vertikale Linien dargestellt. Ihre Beschreibung wird in den Tooltips angezeigt, wenn man mit der Maus über sie fährt. Sie werden von einer "Table"-Chart geholt, die die Daten enthält. Man kann Spalten Zeit und Beschreibung auswählen.

### Intervall-Annotationen

Genau wie Events, aber mit einem Start- und Enddatum, werden sie als Bereich dargestellt.

### Zeitreihen-Annotationen

Zeitreihen werden als zusätzliche Linie auf dem Liniendiagramm hinzugefügt. Der Name und die Anzeigeeigenschaften können konfiguriert werden. Die Daten werden von einer beliebigen Zeitreihen-Chart geholt.

### Formel-Annotationen

Formeln werden als zusätzliche Linie in das Diagramm eingefügt. Sie können einen mathematischen Ausdruck eingeben, der auf der Client-Seite mit "mathjs" ausgewertet wird. Man kann die Anzeigeeigenschaften festlegen und beliebige mathematische Formel angeben.

== ANHANG: Die Map Charts

Hier siehst du elf Map-Charts und deren Auswahlmöglichkeiten. Mittels einer roten Box ist jeweils markiert, welche Optionen benötigt werden um ein solches Diagramm zu erstellen.

.Visualization Type Mapbox, links am Beispiel Punkte in San Francisco, Kalifornien, rechts die dazugehörige Eingabemaske
image::einfuehrung_in_apache_superset_fortsetzung/mapbox.png[pdfwidth=75%]

.Visualization Type Deck.gl Scatterplot (entspricht scatter plot in Excel), links am Beispiel Punkte in San Francisco, Kalifornien, rechts die dazugehörige Eingabemaske
image::einfuehrung_in_apache_superset_fortsetzung/deckgl_scatterplot.png[pdfwidth=75%]

.Visualization Type Deck.gl Path, links am Beispiel Routen in Kalifornien, rechts die dazugehörige Eingabemaske
image::einfuehrung_in_apache_superset_fortsetzung/deckgl_path.png[pdfwidth=75%]

.Visualization Type Deck.gl Arc, links am Beispiel Inland-Flüge in den USA, rechts die dazugehörige Eingabemaske
image::einfuehrung_in_apache_superset_fortsetzung/deckgl_arc.png[pdfwidth=75%]

.Visualization Type Country Map, links am Beispiel die Geburtenrate 2014 in den französischen Departements, rechts die dazugehörige Eingabemaske
image::einfuehrung_in_apache_superset_fortsetzung/country_map.png[pdfwidth=75%]

.Visualization Type Deck.gl Polygon, links am Beispiel Bezirke in San Francisco und deren Bevölkerungsdichte, rechts die dazugehörige Eingabemaske
image::einfuehrung_in_apache_superset_fortsetzung/deckgl_polygon.png[pdfwidth=75%]

.Visualization Type World Map, links am Beispiel der Anteil Bewohner die auf dem Land wohnen, rechts die dazugehörige Eingabemaske
image::einfuehrung_in_apache_superset/rural_pdf.png[pdfwidth=75%]

.Visualization Type Deck.gl 3D Hexagon, links am Beispiel Punkte in San Francisco, Kalifornien, rechts die dazugehörige Eingabemaske
image::einfuehrung_in_apache_superset_fortsetzung/deckgl_3dhexagon.png[pdfwidth=75%]

.Visualization Type Deck.gl Grid, links am Beispiel Punkte in San Francisco, Kalifornien, rechts die dazugehörige Eingabemaske
image::einfuehrung_in_apache_superset_fortsetzung/deckgl_grid.png[pdfwidth=75%]

.Visualization Type Deck.gl Screen Grid, links am Beispiel Punkte in San Francisco, Kalifornien, rechts die dazugehörige Eingabemaske
image::einfuehrung_in_apache_superset_fortsetzung/deckgl_screengrid.png[pdfwidth=75%]

.Visualization Type Deck.gl Multiple Layers, links am Beispiel die obigen Charts deck.gl Scatterplot und deck.gl Path zusammengeführt, rechts die dazugehörige Eingabemaske
image::einfuehrung_in_apache_superset_fortsetzung/deckgl_multiple_layers.png[pdfwidth=75%]